{% extends 'base.html' %}

{% load widget_tweaks %}

{% block title %}TFD - Formulário{% endblock %}

{% block content %}
<div class="container py-4 py-md-5">
    <!-- Hero -->
    <div class="p-4 p-md-5 rounded-3 mb-4" style="background-image: linear-gradient(90deg, #198754, #20c997); box-shadow: 0 8px 24px rgba(25,135,84,.25);">
        <div class="d-flex flex-column flex-md-row align-items-md-center gap-3 text-white">
            <div class="display-6"><i class="bi bi-journal-plus"></i></div>
            <div class="flex-grow-1">
                <h2 class="fw-bold mb-1">{% if form.instance.pk %}Editar{% else %}Novo{% endif %} TFD</h2>
                <div class="text-white-50">Preencha os dados do paciente, viagem e valores</div>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'tfd-list' %}" class="btn btn-outline-light"><i class="bi bi-arrow-left"></i> Voltar</a>
            </div>
        </div>
    </div>

    <div class="card shadow-sm app-card">
        <div class="app-accent accent-success"></div>
        <div class="card-body">
            <style>
                .tf-address textarea.form-control { min-height: 56px; max-height: 120px; resize: vertical; }
            </style>

            <script>
                // Atualiza número de diárias a partir do período
                function calcularDiariasPorPeriodo() {
                    const inicioEl = document.getElementById('id_data_inicio');
                    const fimEl = document.getElementById('id_data_fim');
                    if (!inicioEl) return;
                    const inicioVal = inicioEl.value;
                    const fimVal = fimEl ? fimEl.value : null;
                    if (inicioVal && fimVal) {
                        const inicio = new Date(inicioVal);
                        const fim = new Date(fimVal);
                        const diffMs = fim - inicio;
                        const dias = Math.floor(diffMs / (1000 * 60 * 60 * 24)) + 1;
                        const diasValid = dias > 0 ? dias : 1;
                        const numEl = document.getElementById('id_numero_diarias');
                        if (numEl) {
                            numEl.value = diasValid;
                            // dispara evento para recálculo de total em outros listeners
                            try { numEl.dispatchEvent(new Event('input')); } catch (e) {}
                        }
                    }
                }

                document.addEventListener('DOMContentLoaded', function () {
                    const inicioEl = document.getElementById('id_data_inicio');
                    const fimEl = document.getElementById('id_data_fim');

                    if (inicioEl) inicioEl.addEventListener('change', calcularDiariasPorPeriodo);
                    if (fimEl) fimEl.addEventListener('change', calcularDiariasPorPeriodo);

                    // set default data para hoje no inicio se estiver vazio
                    if (inicioEl && !inicioEl.value) {
                        const hoje = new Date().toISOString().slice(0, 10);
                        inicioEl.value = hoje;
                    }
                });
            </script>

            <form id="tfd-form" method="post" class="needs-validation" novalidate>
                {% csrf_token %}

                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="text-uppercase text-muted mb-2">Dados do Paciente</h6>
                    </div>
                    <div class="col-md-6 position-relative">
                        <label class="form-label">Paciente (vinculado)</label>
                        <input type="text" id="tfd-busca-paciente" class="form-control mb-2" placeholder="Digite nome, CPF ou CNS para buscar..." autocomplete="off" />
                        <div id="tfd-resultado-paciente" class="list-group position-absolute w-100" style="z-index: 1000;"></div>
                        {{ form.paciente|add_class:"form-select" }}
                        <div class="form-text">Selecione um paciente para preencher automaticamente os dados do paciente.</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Acompanhante (se houver)</label>
                        {{ form.paciente_nome|add_class:"form-control" }}
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">CPF</label>
                        {{ form.paciente_cpf|add_class:"form-control" }}
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">CNS</label>
                        {{ form.paciente_cns|add_class:"form-control" }}
                    </div>
                    <div class="col-md-8 tf-address">
                        <label class="form-label">Endereço</label>
                        {{ form.paciente_endereco|add_class:"form-control" }}
                        <div class="form-text">Formato curto: rua, nº, bairro. Máx. 300 caracteres.</div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Telefone</label>
                        {{ form.paciente_telefone|add_class:"form-control" }}
                    </div>

                    <div class="col-12 mt-2">
                        <h6 class="text-uppercase text-muted mb-2">Viagem</h6>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Cidade de destino</label>
                        {{ form.cidade_destino|add_class:"form-control" }}
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Data início</label>
                        {{ form.data_inicio|add_class:"form-control" }}
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Data fim</label>
                        {{ form.data_fim|add_class:"form-control" }}
                    </div>

                    <div class="col-12 mt-2">
                        <h6 class="text-uppercase text-muted mb-2">Valores</h6>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Número de diárias</label>
                        {{ form.numero_diarias|add_class:"form-control" }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Valor da diária (R$)</label>
                        <div class="input-group">
                            <span class="input-group-text">R$</span>
                            {{ form.valor_diaria|add_class:"form-control text-end" }}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Valor do Auxílio Municipal (R$)</label>
                        <div class="input-group">
                            <span class="input-group-text">R$</span>
                            {{ form.valor_beneficio|add_class:"form-control text-end" }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Valor total (R$)</label>
                        <div class="input-group">
                            <span class="input-group-text">R$</span>
                            {{ form.valor_total|add_class:"form-control text-end" }}
                        </div>
                        <div class="form-text">Calculado automaticamente como <code>valor_beneficio + (valor_diaria × número_diarias)</code> se não informado.</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Observações</label>
                        {{ form.observacoes|add_class:"form-control" }}
                    </div>
                </div>

                <div class="card-footer bg-transparent border-0 px-0 mt-4 d-flex justify-content-end gap-2">
                    <a href="{% url 'tfd-list' %}" class="btn btn-outline-secondary"><i class="bi bi-x-lg"></i> Cancelar</a>
                    <button type="submit" class="btn btn-success"><i class="bi bi-check2"></i> Salvar registro</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Auto-calcula valor_total quando usuario altera diária ou número de diárias
    const diariaInput = document.querySelector('[name="valor_diaria"]');
    const numeroInput = document.querySelector('[name="numero_diarias"]');
    const totalInput = document.querySelector('[name="valor_total"]');
    const beneficioInput = document.querySelector('[name="valor_beneficio"]');

    function parseNumber(v){
        if (v === null || v === undefined) return 0;
        v = String(v).trim();
        if (v === '') return 0;
        // Se contém vírgula, assumir formato brasileiro: remover pontos de milhares e trocar vírgula por ponto
        if (v.indexOf(',') !== -1){
            v = v.replace(/\./g, '');
            v = v.replace(/,/g, '.');
        } else {
            // caso não tenha vírgula, remover vírgulas acidentais e espaços
            v = v.replace(/,/g, '');
        }
        v = v.replace(/\s+/g, '');
        const n = parseFloat(v);
        return isNaN(n) ? 0 : n;
    }

    function recalc(){
        const diaria = parseNumber(diariaInput ? diariaInput.value : 0);
        // número de diárias padrão = 1 quando vazio
        const numRaw = numeroInput ? numeroInput.value : '';
        const num = parseInt(numRaw) || 1;
        const beneficio = parseNumber(beneficioInput ? beneficioInput.value : 0);
        const total = (diaria * num) + beneficio;
        if (!totalInput) return;
        // atualizar sempre para refletir os campos atuais
        totalInput.value = total.toFixed(2);
    }

    [diariaInput, numeroInput, beneficioInput].forEach(el => {
        if (!el) return;
        el.addEventListener('input', recalc);
        el.addEventListener('change', recalc);
    });

    // referência a campo obsoleto `data_viagem` removida

    // bootstrap validation
    const form = document.getElementById('tfd-form');
    form.addEventListener('submit', function(event){
        if (!form.checkValidity()){
            event.preventDefault();
            event.stopPropagation();
        }
        form.classList.add('was-validated');
    }, false);

    // Autocomplete Paciente para TFD
    const buscaInput = document.getElementById('tfd-busca-paciente');
    const resultadoList = document.getElementById('tfd-resultado-paciente');
    const pacienteSelect = document.getElementById('id_paciente');
    const nomeInput = document.getElementById('id_paciente_nome');
    const cpfInput = document.getElementById('id_paciente_cpf');
    const cnsInput = document.getElementById('id_paciente_cns');
    const endInput = document.getElementById('id_paciente_endereco');
    const telInput = document.getElementById('id_paciente_telefone');

    if (buscaInput && resultadoList && pacienteSelect){
        let debounce;
        function clearRes(){ resultadoList.innerHTML=''; resultadoList.style.display='none'; }
        function render(items){
            resultadoList.innerHTML='';
            items.forEach(item => {
                const a = document.createElement('a');
                a.href = '#';
                a.className = 'list-group-item list-group-item-action';
                a.textContent = item.label || item.nome;
                a.addEventListener('click', (e)=>{
                    e.preventDefault();
                    pacienteSelect.innerHTML = '';
                    const opt = document.createElement('option');
                    opt.value = item.id; opt.selected = true; opt.textContent = item.nome;
                    pacienteSelect.appendChild(opt);
                    if (nomeInput && !nomeInput.value) nomeInput.value = item.nome || '';
                    if (cpfInput && !cpfInput.value && item.cpf) cpfInput.value = item.cpf;
                    if (cnsInput && !cnsInput.value && item.cns) cnsInput.value = item.cns;
                    if (endInput && !endInput.value && item.endereco) endInput.value = item.endereco;
                    if (telInput && !telInput.value && item.telefone) telInput.value = item.telefone;
                    buscaInput.value = item.nome || '';
                    clearRes();
                });
                resultadoList.appendChild(a);
            });
            resultadoList.style.display = items.length ? 'block' : 'none';
        }
        function buscar(q){
            const url = new URL('{% url "paciente_autocomplete" %}', window.location.origin);
            url.searchParams.set('q', q); url.searchParams.set('limit','20');
            fetch(url.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(r => r.ok ? r.json() : Promise.reject())
                .then(d => render((d && d.results) || []))
                .catch(() => clearRes());
        }
        buscaInput.addEventListener('input', function(){
            const v = (this.value||'').trim();
            clearTimeout(debounce);
            if (v.length < 2){ clearRes(); return; }
            debounce = setTimeout(()=> buscar(v), 250);
        });
        document.addEventListener('click', function(e){
            if (!resultadoList.contains(e.target) && e.target !== buscaInput){ clearRes(); }
        });
    }
});
</script>

<style>
    .app-card { border: none; border-radius: 1rem; overflow: hidden; }
    .app-accent { height: 6px; width: 100%; background: var(--accent-grad, #198754); }
    .accent-success { --accent-grad: linear-gradient(90deg, #198754, #20c997); }
</style>

{% endblock %}
