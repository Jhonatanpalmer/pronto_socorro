{% extends 'base.html' %}

{% block title %}Tipos de Exames{% endblock %}

{% block content %}
<div class="container py-4 py-md-5">
    <div class="p-4 p-md-5 rounded-3 mb-4" style="background-image: linear-gradient(90deg, #20c997, #0d6efd); box-shadow: 0 8px 24px rgba(13,110,253,.25);">
        <div class="d-flex flex-column flex-md-row align-items-md-center gap-3 text-white">
            <div class="display-6"><i class="bi bi-clipboard-data"></i></div>
            <div class="flex-grow-1">
                <h2 class="fw-bold mb-1">Tipos de Exames</h2>
                <div class="text-white-50">Gerencie e pesquise por código ou nome</div>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'importar-sigtap' %}" class="btn btn-light text-primary"><i class="bi bi-cloud-arrow-up"></i> Importar SIGTAP</a>
                <a href="{% url 'tipo-exame-create' %}" class="btn btn-dark"><i class="bi bi-plus-lg"></i> Novo Tipo</a>
                <a href="{% url 'regulacao-dashboard' %}" class="btn btn-outline-light"><i class="bi bi-arrow-left"></i> Voltar</a>
            </div>
        </div>
    </div>

    <div class="card shadow-sm app-card">
        <div class="app-accent accent-teal"></div>
        <div class="card-body">
            <form method="get" class="row g-2 align-items-center mb-3">
                <div class="col-12 col-md-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" name="q" value="{{ q }}" placeholder="Buscar por código, nome ou código SUS" autocomplete="off">
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="input-group input-group-sm">
                        <label class="input-group-text" for="f-ativo">Status</label>
                        <select id="f-ativo" name="ativo" class="form-select">
                            <option value="" {% if ativo_filter == '' %}selected{% endif %}>Todos</option>
                            <option value="1" {% if ativo_filter == '1' %}selected{% endif %}>Apenas ativos</option>
                            <option value="0" {% if ativo_filter == '0' %}selected{% endif %}>Apenas inativos</option>
                        </select>
                    </div>
                </div>
                <div class="col-6 col-md-3 text-md-end">
                    <button class="btn btn-sm btn-primary" type="submit">Buscar</button>
                    <a class="btn btn-sm btn-outline-secondary" href="{% url 'tipo-exame-list' %}">Limpar</a>
                </div>
            </form>
            {% if tipoexame_list %}
            <form method="post" class="mb-2">
                {% csrf_token %}
                <input type="hidden" name="q" value="{{ q }}">
                <input type="hidden" name="ativo" value="{{ ativo_filter }}">
                <input type="hidden" name="page" value="{{ page_obj.number|default:1 }}">
                <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-2">
                    <div class="small text-muted">
                        Selecione itens e aplique uma ação em massa.
                    </div>
                    <div class="btn-group btn-group-sm" role="group" aria-label="Ações em massa">
                        <button name="action" value="ativar" class="btn btn-success" type="submit"><i class="bi bi-check2-circle"></i> Ativar selecionados</button>
                        <button name="action" value="desativar" class="btn btn-outline-secondary" type="submit"><i class="bi bi-slash-circle"></i> Desativar selecionados</button>
                    </div>
                </div>
                <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th style="width:36px;">
                                <input class="form-check-input" type="checkbox" id="chk-all" onclick="document.querySelectorAll('input[name=\'ids\']').forEach(cb=>cb.checked=this.checked)" aria-label="Selecionar todos">
                            </th>
                            <th>Código</th>
                            <th>Nome do Exame</th>
                            <th>Descrição</th>
                            <th>Valor</th>
                            <th>Status</th>
                            <th class="text-end">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tipo in tipoexame_list %}
                        <tr>
                            <td>
                                <input class="form-check-input" type="checkbox" name="ids" value="{{ tipo.id }}" aria-label="Selecionar {{ tipo.nome }}">
                            </td>
                            <td>
                                <span class="badge bg-secondary">{{ tipo.codigo|default:"-" }}</span>
                            </td>
                            <td>
                                <strong>{{ tipo.nome }}</strong>
                                {% if tipo.codigo_sus %}
                                <div class="small text-muted">SUS: {{ tipo.codigo_sus }}</div>
                                {% endif %}
                            </td>
                            <td>
                                {% if tipo.descricao %}
                                {{ tipo.descricao|truncatechars:80 }}
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if tipo.valor %}
                                <span class="text-success fw-bold">
                                    R$ {{ tipo.valor|floatformat:2 }}
                                </span>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if tipo.ativo %}
                                <span class="badge bg-success">Ativo</span>
                                {% else %}
                                <span class="badge bg-secondary">Inativo</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                <a href="{% url 'tipo-exame-update' tipo.pk %}" class="btn btn-sm btn-outline-primary" title="Editar">
                                    <i class="bi bi-pencil-fill"></i>
                                </a>
                                <a href="{% url 'tipo-exame-delete' tipo.pk %}" class="btn btn-sm btn-outline-danger" title="Excluir">
                                    <i class="bi bi-trash-fill"></i>
                                </a>
                                <a href="{% url 'tipo-exame-toggle-ativo' tipo.pk %}?next={{ request.get_full_path|urlencode }}" class="btn btn-sm {% if tipo.ativo %}btn-outline-secondary{% else %}btn-outline-success{% endif %}" title="{% if tipo.ativo %}Desativar{% else %}Ativar{% endif %}">
                                    {% if tipo.ativo %}<i class="bi bi-toggle-off"></i> Desativar{% else %}<i class="bi bi-toggle-on"></i> Ativar{% endif %}
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                </div>
            </form>
            {% else %}
            <div class="alert alert-info shadow-sm text-center">
                <i class="bi bi-info-circle-fill me-2"></i>
                Nenhum tipo de exame encontrado.
            </div>
            {% endif %}

            {% if is_paginated %}
            <nav class="mt-3" aria-label="Paginação">
                <ul class="pagination pagination-sm justify-content-end mb-0">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if q %}&q={{ q|urlencode }}{% endif %}">Anterior</a>
                    </li>
                    {% else %}
                    <li class="page-item disabled"><span class="page-link">Anterior</span></li>
                    {% endif %}

                    {% for num in paginator.page_range %}
                        {% if num == page_obj.number %}
                        <li class="page-item active" aria-current="page"><span class="page-link">{{ num }}</span></li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <li class="page-item"><a class="page-link" href="?page={{ num }}{% if q %}&q={{ q|urlencode }}{% endif %}">{{ num }}</a></li>
                        {% endif %}
                    {% endfor %}

                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if q %}&q={{ q|urlencode }}{% endif %}">Próxima</a>
                    </li>
                    {% else %}
                    <li class="page-item disabled"><span class="page-link">Próxima</span></li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
</div>
<style>
  .app-card { border: none; border-radius: 1rem; overflow: hidden; }
  .app-accent { height: 6px; width: 100%; background: var(--accent-grad, #20c997); }
  .accent-teal { --accent-grad: linear-gradient(90deg, #20c997, #0d6efd); }
</style>
{% endblock %}