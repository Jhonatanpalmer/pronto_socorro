{% extends 'base.html' %}
{% block title %}Regular Consulta{% endblock %}
{% block content %}
<div class="container py-4">
  <div class="card">
    <div class="card-header bg-warning text-dark">
      <strong>Regular Consulta — Protocolo {{ regulacao.numero_protocolo }}</strong>
    </div>
    <div class="card-body">
      <dl class="row">
        <dt class="col-sm-3">Paciente</dt><dd class="col-sm-9">{{ regulacao.paciente.nome }}</dd>
        <dt class="col-sm-3">Especialidade</dt><dd class="col-sm-9">{{ regulacao.especialidade.nome }}</dd>
        <dt class="col-sm-3">UBS</dt><dd class="col-sm-9">{{ regulacao.ubs_solicitante.nome }}</dd>
        <dt class="col-sm-3">Status atual</dt><dd class="col-sm-9"><span class="badge {{ regulacao.get_status_badge_class }}">{{ regulacao.get_status_display }}</span></dd>
      </dl>

      <form method="post">{% csrf_token %}
        <div class="mb-3">
          <label class="form-label">Decisão</label>
          <select id="decisao" name="decisao" class="form-select" required>
            <option value="">Selecione...</option>
            <option value="autorizado" {% if decisao == 'autorizado' %}selected{% endif %}>Autorizar</option>
            <option value="negado" {% if decisao == 'negado' %}selected{% endif %}>Negar</option>
          </select>
        </div>
        <div id="campos-autorizacao" style="display:none;">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Local de Atendimento</label>
              <input type="text" class="form-control" name="local_atendimento" value="{{ request.POST.local_atendimento|default:regulacao.local_atendimento }}" />
            </div>
            <div class="col-md-3">
              <label class="form-label">Data do Agendamento</label>
              <input type="date" class="form-control" name="data_agendada" value="{{ request.POST.data_agendada|default:regulacao.data_agendada|date:'Y-m-d' }}" />
            </div>
            <div class="col-md-3">
              <label class="form-label">Hora</label>
              <input type="time" class="form-control" name="hora_agendada" value="{{ request.POST.hora_agendada|default:regulacao.hora_agendada|time:'H:i' }}" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Médico Atendente</label>
              <select class="form-select" name="medico_atendente">
                <option value="">Selecione...</option>
                {% for m in medicos %}
                <option value="{{ m.id }}" {% if request.POST.medico_atendente == m.id|stringformat:'s' or regulacao.medico_atendente_id == m.id %}selected{% endif %}>{{ m.nome }} (CRM {{ m.crm }})</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="mt-3">
            <label class="form-label">Observações da Regulação</label>
            <textarea class="form-control" name="observacoes_regulacao" rows="2">{{ request.POST.observacoes_regulacao|default:regulacao.observacoes_regulacao }}</textarea>
          </div>
        </div>
        <div class="mb-3 mt-3">
          <label class="form-label">Justificativa</label>
          <textarea name="justificativa" class="form-control" rows="3" required>{{ request.POST.justificativa }}</textarea>
        </div>
        <div class="d-flex justify-content-end gap-2 mt-3">
          <a class="btn btn-secondary" href="{% url 'consulta-list' %}">Cancelar</a>
          <button type="submit" class="btn btn-success">Salvar</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

<script>
document.addEventListener('DOMContentLoaded', function(){
  const decisao = document.getElementById('decisao');
  const bloco = document.getElementById('campos-autorizacao');
  const reqFields = [
    'input[name="local_atendimento"]',
    'input[name="data_agendada"]',
    'input[name="hora_agendada"]',
    'select[name="medico_atendente"]'
  ].map(s => document.querySelector(s));
  function toggle(){
    const on = decisao && decisao.value === 'autorizado';
    bloco.style.display = on ? 'block' : 'none';
    reqFields.forEach(el => { if (el){ el.required = on; el.disabled = !on; }});
  }
  if (decisao) decisao.addEventListener('change', toggle);
  // se houve POST e a decisão foi 'autorizado', garantir exibição
  {% if decisao == 'autorizado' %}
    decisao.value = 'autorizado';
  {% endif %}
  toggle();
});
</script>
