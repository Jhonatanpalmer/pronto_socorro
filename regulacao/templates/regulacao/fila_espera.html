{% extends 'base.html' %}
{% block title %}Fila de Espera{% endblock %}
{% block content %}
<div class="container py-4 py-md-5">
  <!-- Hero -->
  <div class="p-4 p-md-5 rounded-3 mb-4" style="background-image: linear-gradient(90deg, #ffc107, #fd7e14); box-shadow: 0 8px 24px rgba(253,126,20,.25);">
    <div class="d-flex flex-column flex-md-row align-items-md-center gap-3 text-dark">
      <div class="display-6"><i class="bi bi-hourglass-split"></i></div>
      <div class="flex-grow-1">
        <h2 class="fw-bold mb-1">Fila de Espera</h2>
        <div class="text-dark-50">Consultas e Exames aguardando</div>
      </div>
      <div class="d-flex gap-2">
        <a href="{% url 'regulacao-agenda' %}" class="btn btn-dark"><i class="bi bi-calendar2-week"></i> Ver Agenda</a>
      </div>
    </div>
  </div>

  <ul class="nav nav-pills mb-3" id="filaTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link {% if only != 'ex' %}active{% endif %}" id="consultas-tab" data-bs-toggle="pill" data-bs-target="#consultas-pane" type="button" role="tab" aria-controls="consultas-pane" aria-selected="{% if only != 'ex' %}true{% else %}false{% endif %}">Consultas</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link {% if only == 'ex' %}active{% endif %}" id="exames-tab" data-bs-toggle="pill" data-bs-target="#exames-pane" type="button" role="tab" aria-controls="exames-pane" aria-selected="{% if only == 'ex' %}true{% else %}false{% endif %}">Exames</button>
    </li>
  </ul>

  <div class="tab-content" id="filaTabsContent">
    <div class="tab-pane fade {% if only != 'ex' %}show active{% endif %}" id="consultas-pane" role="tabpanel" aria-labelledby="consultas-tab" tabindex="0">
      <div class="card h-100 shadow-sm mb-4 app-card" id="fila-consultas">
        <div class="app-accent accent-warning"></div>
        <div class="card-header bg-transparent border-0 pt-3 pb-0"><strong>Consultas</strong></div>
        <div class="card-body">
          <form method="get" class="row g-2 align-items-center mb-2">
            <div class="col-12 col-md-5">
              <input type="text" name="q_co" value="{{ q_co }}" class="form-control form-control-sm" placeholder="Buscar por paciente, especialidade ou UBS..." />
              {% if q_ex %}<input type="hidden" name="q_ex" value="{{ q_ex }}">{% endif %}
              {% if di %}<input type="hidden" name="di" value="{{ di }}">{% endif %}
              {% if df %}<input type="hidden" name="df" value="{{ df }}">{% endif %}
              <input type="hidden" name="only" value="co">
            </div>
            <div class="col-12 col-md-5">
              <div class="input-group input-group-sm">
                <span class="input-group-text">De</span>
                <input type="date" class="form-control" name="di" value="{{ di }}">
                <span class="input-group-text">até</span>
                <input type="date" class="form-control" name="df" value="{{ df }}">
              </div>
            </div>
            <div class="col-12 col-md-2 text-md-end">
              <button class="btn btn-sm btn-primary" type="submit"><i class="bi bi-search"></i></button>
              <a class="btn btn-sm btn-outline-secondary" href="{% url 'regulacao-fila' %}?only=co#consultas-pane" title="Limpar filtros mantendo a aba"><i class="bi bi-x"></i></a>
            </div>
          </form>
          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle mb-0">
              <colgroup>
                <col style="width: 35%">
                <col style="width: 25%">
                <col style="width: 25%">
                <col style="width: 15%">
              </colgroup>
              <thead>
                <tr class="table-light">
                  <th>Paciente</th>
                  <th>UBS solicitante</th>
                  <th>Consultas na fila</th>
                  <th class="text-nowrap text-end">Desde</th>
                </tr>
              </thead>
              <tbody>
                {% for g in consultas %}
                <tr>
                  <td>
                    <div class="fw-semibold text-truncate" style="max-width: 360px;" title="{{ g.paciente.nome }}">{{ g.paciente.nome }}</div>
                    <a href="{% url 'paciente-pedido' g.paciente_id %}?only=co" class="btn btn-warning btn-sm mt-1 fw-semibold shadow-sm">
                      <i class="bi bi-box-arrow-up-right"></i> Ver pedido
                    </a>
                  </td>
                  <td>
                    {% if g.ubs %}
                      <div class="text-truncate" style="max-width: 260px;" title="{{ g.ubs|join:', ' }}">{{ g.ubs|join:', ' }}</div>
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                  <td>
                    <span class="badge bg-info-subtle text-dark border">{{ g.total }} no total</span>
                    {% if g.nomes %}
                      <div class="small text-muted text-truncate" style="max-width: 360px;" title="{{ g.nomes|join:', ' }}">
                        {{ g.nomes|join:', ' }}
                      </div>
                    {% endif %}
                  </td>
                  <td class="text-nowrap text-end">{{ g.desde|date:'d/m/Y H:i' }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="4" class="text-center py-3 text-muted">Nenhuma consulta em fila.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="d-flex justify-content-between align-items-center mt-2 small text-muted">
            <div>
              Mostrando {{ consultas|length }} de {{ p_co.count }} paciente(s) — ordem: mais antigos primeiro
            </div>
            <div class="d-flex align-items-center gap-2">
              <label for="per_co" class="me-1">por página</label>
              <form method="get" class="d-inline">
                <input type="hidden" name="only" value="co">
                {% if q_co %}<input type="hidden" name="q_co" value="{{ q_co }}">{% endif %}
                {% if q_ex %}<input type="hidden" name="q_ex" value="{{ q_ex }}">{% endif %}
                {% if di %}<input type="hidden" name="di" value="{{ di }}">{% endif %}
                {% if df %}<input type="hidden" name="df" value="{{ df }}">{% endif %}
                <select id="per_co" name="per_co" class="form-select form-select-sm d-inline-block" style="width:auto" onchange="this.form.submit()">
                  <option value="5" {% if per_co == 5 %}selected{% endif %}>5</option>
                  <option value="10" {% if per_co == 10 %}selected{% endif %}>10</option>
                </select>
              </form>
            </div>
          </div>
          {% if consultas.has_other_pages %}
          <nav class="mt-2" aria-label="Paginação Consultas">
            <ul class="pagination pagination-sm justify-content-end mb-0">
              {% if consultas.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page_co={{ consultas.previous_page_number }}&page_ex={{ exames.number }}&per_co={{ per_co }}{% if q_ex %}&q_ex={{ q_ex }}{% endif %}{% if q_co %}&q_co={{ q_co }}{% endif %}{% if di %}&di={{ di }}{% endif %}{% if df %}&df={{ df }}{% endif %}{% if only %}&only={{ only }}{% endif %}">&laquo;</a>
              </li>
              {% else %}
              <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
              {% endif %}
              {% for num in consultas.paginator.page_range %}
              <li class="page-item {% if num == consultas.number %}active{% endif %}"><a class="page-link" href="?page_co={{ num }}&page_ex={{ exames.number }}&per_co={{ per_co }}{% if q_ex %}&q_ex={{ q_ex }}{% endif %}{% if q_co %}&q_co={{ q_co }}{% endif %}{% if di %}&di={{ di }}{% endif %}{% if df %}&df={{ df }}{% endif %}{% if only %}&only={{ only }}{% endif %}">{{ num }}</a></li>
              {% endfor %}
              {% if consultas.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page_co={{ consultas.next_page_number }}&page_ex={{ exames.number }}&per_co={{ per_co }}{% if q_ex %}&q_ex={{ q_ex }}{% endif %}{% if q_co %}&q_co={{ q_co }}{% endif %}{% if di %}&di={{ di }}{% endif %}{% if df %}&df={{ df }}{% endif %}{% if only %}&only={{ only }}{% endif %}">&raquo;</a>
              </li>
              {% else %}
              <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
              {% endif %}
            </ul>
          </nav>
          {% endif %}
        </div>
      </div>
    </div>

  <div class="tab-pane fade {% if only == 'ex' %}show active{% endif %}" id="exames-pane" role="tabpanel" aria-labelledby="exames-tab" tabindex="0">
      <div class="card h-100 shadow-sm app-card" id="fila-exames">
        <div class="app-accent accent-primary"></div>
        <div class="card-header bg-transparent border-0 pt-3 pb-0"><strong>Exames</strong></div>
        <div class="card-body">
          <form method="get" class="row g-2 align-items-center mb-2">
            <div class="col-12 col-md-5">
              <input type="text" name="q_ex" value="{{ q_ex }}" class="form-control form-control-sm" placeholder="Buscar por paciente, exame ou UBS..." />
              {% if q_co %}<input type="hidden" name="q_co" value="{{ q_co }}">{% endif %}
              {% if di %}<input type="hidden" name="di" value="{{ di }}">{% endif %}
              {% if df %}<input type="hidden" name="df" value="{{ df }}">{% endif %}
              <input type="hidden" name="only" value="ex">
            </div>
            <div class="col-12 col-md-5">
              <div class="input-group input-group-sm">
                <span class="input-group-text">De</span>
                <input type="date" class="form-control" name="di" value="{{ di }}">
                <span class="input-group-text">até</span>
                <input type="date" class="form-control" name="df" value="{{ df }}">
              </div>
            </div>
            <div class="col-12 col-md-2 text-md-end">
              <button class="btn btn-sm btn-primary" type="submit"><i class="bi bi-search"></i></button>
              <a class="btn btn-sm btn-outline-secondary" href="{% url 'regulacao-fila' %}?only=ex#exames-pane" title="Limpar filtros mantendo a aba"><i class="bi bi-x"></i></a>
            </div>
          </form>
          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle mb-0">
              <colgroup>
                <col style="width: 35%">
                <col style="width: 25%">
                <col style="width: 25%">
                <col style="width: 15%">
              </colgroup>
              <thead>
                <tr class="table-light">
                  <th>Paciente</th>
                  <th>UBS solicitante</th>
                  <th>Exames na fila</th>
                  <th class="text-nowrap text-end">Desde</th>
                </tr>
              </thead>
              <tbody>
                {% for g in exames %}
                <tr>
                  <td>
                    <div class="fw-semibold text-truncate" style="max-width: 360px;" title="{{ g.paciente.nome }}">{{ g.paciente.nome }}</div>
                    <a href="{% url 'paciente-pedido' g.paciente_id %}?only=ex" class="btn btn-warning btn-sm mt-1 fw-semibold shadow-sm">
                      <i class="bi bi-box-arrow-up-right"></i> Ver pedido
                    </a>
                  </td>
                  <td>
                    {% if g.ubs %}
                      <div class="text-truncate" style="max-width: 260px;" title="{{ g.ubs|join:', ' }}">{{ g.ubs|join:', ' }}</div>
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                  <td>
                    <span class="badge bg-info-subtle text-dark border">{{ g.total }} no total</span>
                    {% if g.nomes %}
                      <div class="small text-muted text-truncate" style="max-width: 360px;" title="{{ g.nomes|join:', ' }}">
                        {{ g.nomes|join:', ' }}
                      </div>
                    {% endif %}
                  </td>
                  <td class="text-nowrap text-end">{{ g.desde|date:'d/m/Y H:i' }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="4" class="text-center py-3 text-muted">Nenhum exame em fila.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="d-flex justify-content-between align-items-center mt-2 small text-muted">
            <div>
              Mostrando {{ exames|length }} de {{ p_ex.count }} paciente(s) — ordem: mais antigos primeiro
            </div>
            <div class="d-flex align-items-center gap-2">
              <label for="per_ex" class="me-1">por página</label>
              <form method="get" class="d-inline">
                <input type="hidden" name="only" value="ex">
                {% if q_co %}<input type="hidden" name="q_co" value="{{ q_co }}">{% endif %}
                {% if q_ex %}<input type="hidden" name="q_ex" value="{{ q_ex }}">{% endif %}
                {% if di %}<input type="hidden" name="di" value="{{ di }}">{% endif %}
                {% if df %}<input type="hidden" name="df" value="{{ df }}">{% endif %}
                <select id="per_ex" name="per_ex" class="form-select form-select-sm d-inline-block" style="width:auto" onchange="this.form.submit()">
                  <option value="5" {% if per_ex == 5 %}selected{% endif %}>5</option>
                  <option value="10" {% if per_ex == 10 %}selected{% endif %}>10</option>
                </select>
              </form>
            </div>
          </div>
          {% if exames.has_other_pages %}
          <nav class="mt-2" aria-label="Paginação Exames">
            <ul class="pagination pagination-sm justify-content-end mb-0">
              {% if exames.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page_ex={{ exames.previous_page_number }}&page_co={{ consultas.number }}&per_ex={{ per_ex }}{% if q_ex %}&q_ex={{ q_ex }}{% endif %}{% if q_co %}&q_co={{ q_co }}{% endif %}{% if di %}&di={{ di }}{% endif %}{% if df %}&df={{ df }}{% endif %}{% if only %}&only={{ only }}{% endif %}">&laquo;</a>
              </li>
              {% else %}
              <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
              {% endif %}
              {% for num in exames.paginator.page_range %}
              <li class="page-item {% if num == exames.number %}active{% endif %}"><a class="page-link" href="?page_ex={{ num }}&page_co={{ consultas.number }}&per_ex={{ per_ex }}{% if q_ex %}&q_ex={{ q_ex }}{% endif %}{% if q_co %}&q_co={{ q_co }}{% endif %}{% if di %}&di={{ di }}{% endif %}{% if df %}&df={{ df }}{% endif %}{% if only %}&only={{ only }}{% endif %}">{{ num }}</a></li>
              {% endfor %}
              {% if exames.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page_ex={{ exames.next_page_number }}&page_co={{ consultas.number }}&per_ex={{ per_ex }}{% if q_ex %}&q_ex={{ q_ex }}{% endif %}{% if q_co %}&q_co={{ q_co }}{% endif %}{% if di %}&di={{ di }}{% endif %}{% if df %}&df={{ df }}{% endif %}{% if only %}&only={{ only }}{% endif %}">&raquo;</a>
              </li>
              {% else %}
              <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
              {% endif %}
            </ul>
          </nav>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  <style>
    .app-card { border: none; border-radius: 1rem; overflow: hidden; box-shadow: 0 8px 24px rgba(0,0,0,.06); }
    .app-accent { height: 6px; width: 100%; background: var(--accent-grad, #0d6efd); }
    .accent-primary { --accent-grad: linear-gradient(90deg, #0d6efd, #6610f2); }
    .accent-warning { --accent-grad: linear-gradient(90deg, #ffc107, #fd7e14); }
    .btn-warning { background-image: linear-gradient(180deg, #ffc107, #fd7e14); border: none; color: #111; }
    .btn-warning:hover { filter: brightness(0.95); }
    .table thead th { border-bottom-width: 2px; }
    .card-header strong { font-size: 1.05rem; }
  </style>

  <script>
    // Manter URL com parâmetro only ao alternar as abas (para persistir estado em reloads)
    (function(){
      const tabs = document.getElementById('filaTabs');
      if (!tabs) return;
      tabs.addEventListener('shown.bs.tab', function (e) {
        const target = e.target?.getAttribute('data-bs-target') || '';
        const url = new URL(window.location.href);
        if (target === '#exames-pane') { url.searchParams.set('only', 'ex'); location.replace(url.toString() + '#exames-pane'); }
        else { url.searchParams.set('only', 'co'); location.replace(url.toString() + '#consultas-pane'); }
      });
    })();
  </script>
</div>
{% endblock %}
