{% extends 'base.html' %}
{% block title %}Fila de Espera{% endblock %}
{% block content %}
<div class="container py-4">
  <h4 class="mb-3">Fila de Espera</h4>

  <ul class="nav nav-pills mb-3" id="filaTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link {% if only != 'ex' %}active{% endif %}" id="consultas-tab" data-bs-toggle="pill" data-bs-target="#consultas-pane" type="button" role="tab" aria-controls="consultas-pane" aria-selected="{% if only != 'ex' %}true{% else %}false{% endif %}">Consultas</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link {% if only == 'ex' %}active{% endif %}" id="exames-tab" data-bs-toggle="pill" data-bs-target="#exames-pane" type="button" role="tab" aria-controls="exames-pane" aria-selected="{% if only == 'ex' %}true{% else %}false{% endif %}">Exames</button>
    </li>
  </ul>

  <div class="tab-content" id="filaTabsContent">
    <div class="tab-pane fade {% if only != 'ex' %}show active{% endif %}" id="consultas-pane" role="tabpanel" aria-labelledby="consultas-tab" tabindex="0">
      <div class="card h-100 shadow-sm mb-4" id="fila-consultas">
        <div class="card-header bg-info text-dark"><strong>Consultas</strong></div>
        <div class="card-body">
          <form method="get" class="row g-2 align-items-center mb-2">
            <div class="col-12 col-md-5">
              <input type="text" name="q_co" value="{{ q_co }}" class="form-control form-control-sm" placeholder="Buscar por paciente, especialidade ou UBS..." />
              {% if q_ex %}<input type="hidden" name="q_ex" value="{{ q_ex }}">{% endif %}
              {% if di %}<input type="hidden" name="di" value="{{ di }}">{% endif %}
              {% if df %}<input type="hidden" name="df" value="{{ df }}">{% endif %}
              <input type="hidden" name="only" value="co">
            </div>
            <div class="col-12 col-md-5">
              <div class="input-group input-group-sm">
                <span class="input-group-text">De</span>
                <input type="date" class="form-control" name="di" value="{{ di }}">
                <span class="input-group-text">até</span>
                <input type="date" class="form-control" name="df" value="{{ df }}">
              </div>
            </div>
            <div class="col-12 col-md-2 text-md-end">
              <button class="btn btn-sm btn-primary" type="submit"><i class="bi bi-search"></i></button>
              <a class="btn btn-sm btn-outline-secondary" href="{% url 'regulacao-fila' %}"><i class="bi bi-x"></i></a>
            </div>
          </form>
          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle mb-0">
              <colgroup>
                <col style="width: 35%">
                <col style="width: 25%">
                <col style="width: 25%">
                <col style="width: 15%">
              </colgroup>
              <thead>
                <tr class="table-light">
                  <th>Paciente</th>
                  <th>UBS solicitante</th>
                  <th>Consultas na fila</th>
                  <th class="text-nowrap text-end">Desde</th>
                </tr>
              </thead>
              <tbody>
                {% for g in consultas %}
                <tr>
                  <td>
                    <div class="fw-semibold text-truncate" style="max-width: 360px;" title="{{ g.paciente.nome }}">{{ g.paciente.nome }}</div>
                    <a href="{% url 'paciente-pedido' g.paciente_id %}" class="btn btn-outline-secondary btn-sm mt-1">
                      <i class="bi bi-box-arrow-up-right"></i> Ver pedido
                    </a>
                  </td>
                  <td>
                    {% if g.ubs %}
                      <div class="text-truncate" style="max-width: 260px;" title="{{ g.ubs|join:', ' }}">{{ g.ubs|join:', ' }}</div>
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                  <td>
                    <span class="badge bg-info-subtle text-dark border">{{ g.total }} no total</span>
                    {% if g.nomes %}
                      <div class="small text-muted text-truncate" style="max-width: 360px;" title="{{ g.nomes|join:', ' }}">
                        {{ g.nomes|join:', ' }}
                      </div>
                    {% endif %}
                  </td>
                  <td class="text-nowrap text-end">{{ g.desde|date:'d/m/Y H:i' }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="4" class="text-center py-3 text-muted">Nenhuma consulta em fila.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% if consultas.has_other_pages %}
          <nav class="mt-2" aria-label="Paginação Consultas">
            <ul class="pagination pagination-sm justify-content-end mb-0">
              {% if consultas.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page_co={{ consultas.previous_page_number }}&page_ex={{ exames.number }}&per_co={{ per_co }}{% if q_ex %}&q_ex={{ q_ex }}{% endif %}{% if q_co %}&q_co={{ q_co }}{% endif %}{% if di %}&di={{ di }}{% endif %}{% if df %}&df={{ df }}{% endif %}{% if only %}&only={{ only }}{% endif %}">&laquo;</a>
              </li>
              {% else %}
              <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
              {% endif %}
              {% for num in consultas.paginator.page_range %}
              <li class="page-item {% if num == consultas.number %}active{% endif %}"><a class="page-link" href="?page_co={{ num }}&page_ex={{ exames.number }}&per_co={{ per_co }}{% if q_ex %}&q_ex={{ q_ex }}{% endif %}{% if q_co %}&q_co={{ q_co }}{% endif %}{% if di %}&di={{ di }}{% endif %}{% if df %}&df={{ df }}{% endif %}{% if only %}&only={{ only }}{% endif %}">{{ num }}</a></li>
              {% endfor %}
              {% if consultas.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page_co={{ consultas.next_page_number }}&page_ex={{ exames.number }}&per_co={{ per_co }}{% if q_ex %}&q_ex={{ q_ex }}{% endif %}{% if q_co %}&q_co={{ q_co }}{% endif %}{% if di %}&di={{ di }}{% endif %}{% if df %}&df={{ df }}{% endif %}{% if only %}&only={{ only }}{% endif %}">&raquo;</a>
              </li>
              {% else %}
              <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
              {% endif %}
            </ul>
          </nav>
          {% endif %}
        </div>
      </div>
    </div>

  <div class="tab-pane fade {% if only == 'ex' %}show active{% endif %}" id="exames-pane" role="tabpanel" aria-labelledby="exames-tab" tabindex="0">
      <div class="card h-100 shadow-sm" id="fila-exames">
        <div class="card-header bg-info text-dark"><strong>Exames</strong></div>
        <div class="card-body">
          <form method="get" class="row g-2 align-items-center mb-2">
            <div class="col-12 col-md-5">
              <input type="text" name="q_ex" value="{{ q_ex }}" class="form-control form-control-sm" placeholder="Buscar por paciente, exame ou UBS..." />
              {% if q_co %}<input type="hidden" name="q_co" value="{{ q_co }}">{% endif %}
              {% if di %}<input type="hidden" name="di" value="{{ di }}">{% endif %}
              {% if df %}<input type="hidden" name="df" value="{{ df }}">{% endif %}
              <input type="hidden" name="only" value="ex">
            </div>
            <div class="col-12 col-md-5">
              <div class="input-group input-group-sm">
                <span class="input-group-text">De</span>
                <input type="date" class="form-control" name="di" value="{{ di }}">
                <span class="input-group-text">até</span>
                <input type="date" class="form-control" name="df" value="{{ df }}">
              </div>
            </div>
            <div class="col-12 col-md-2 text-md-end">
              <button class="btn btn-sm btn-primary" type="submit"><i class="bi bi-search"></i></button>
              <a class="btn btn-sm btn-outline-secondary" href="{% url 'regulacao-fila' %}"><i class="bi bi-x"></i></a>
            </div>
          </form>
          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle mb-0">
              <colgroup>
                <col style="width: 35%">
                <col style="width: 25%">
                <col style="width: 25%">
                <col style="width: 15%">
              </colgroup>
              <thead>
                <tr class="table-light">
                  <th>Paciente</th>
                  <th>UBS solicitante</th>
                  <th>Exames na fila</th>
                  <th class="text-nowrap text-end">Desde</th>
                </tr>
              </thead>
              <tbody>
                {% for g in exames %}
                <tr>
                  <td>
                    <div class="fw-semibold text-truncate" style="max-width: 360px;" title="{{ g.paciente.nome }}">{{ g.paciente.nome }}</div>
                    <a href="{% url 'paciente-pedido' g.paciente_id %}" class="btn btn-outline-secondary btn-sm mt-1">
                      <i class="bi bi-box-arrow-up-right"></i> Ver pedido
                    </a>
                  </td>
                  <td>
                    {% if g.ubs %}
                      <div class="text-truncate" style="max-width: 260px;" title="{{ g.ubs|join:', ' }}">{{ g.ubs|join:', ' }}</div>
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                  <td>
                    <span class="badge bg-info-subtle text-dark border">{{ g.total }} no total</span>
                    {% if g.nomes %}
                      <div class="small text-muted text-truncate" style="max-width: 360px;" title="{{ g.nomes|join:', ' }}">
                        {{ g.nomes|join:', ' }}
                      </div>
                    {% endif %}
                  </td>
                  <td class="text-nowrap text-end">{{ g.desde|date:'d/m/Y H:i' }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="4" class="text-center py-3 text-muted">Nenhum exame em fila.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% if exames.has_other_pages %}
          <nav class="mt-2" aria-label="Paginação Exames">
            <ul class="pagination pagination-sm justify-content-end mb-0">
              {% if exames.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page_ex={{ exames.previous_page_number }}&page_co={{ consultas.number }}&per_ex={{ per_ex }}{% if q_ex %}&q_ex={{ q_ex }}{% endif %}{% if q_co %}&q_co={{ q_co }}{% endif %}{% if di %}&di={{ di }}{% endif %}{% if df %}&df={{ df }}{% endif %}{% if only %}&only={{ only }}{% endif %}">&laquo;</a>
              </li>
              {% else %}
              <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
              {% endif %}
              {% for num in exames.paginator.page_range %}
              <li class="page-item {% if num == exames.number %}active{% endif %}"><a class="page-link" href="?page_ex={{ num }}&page_co={{ consultas.number }}&per_ex={{ per_ex }}{% if q_ex %}&q_ex={{ q_ex }}{% endif %}{% if q_co %}&q_co={{ q_co }}{% endif %}{% if di %}&di={{ di }}{% endif %}{% if df %}&df={{ df }}{% endif %}{% if only %}&only={{ only }}{% endif %}">{{ num }}</a></li>
              {% endfor %}
              {% if exames.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page_ex={{ exames.next_page_number }}&page_co={{ consultas.number }}&per_ex={{ per_ex }}{% if q_ex %}&q_ex={{ q_ex }}{% endif %}{% if q_co %}&q_co={{ q_co }}{% endif %}{% if di %}&di={{ di }}{% endif %}{% if df %}&df={{ df }}{% endif %}{% if only %}&only={{ only }}{% endif %}">&raquo;</a>
              </li>
              {% else %}
              <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
              {% endif %}
            </ul>
          </nav>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
