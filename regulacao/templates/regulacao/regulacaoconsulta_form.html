{% extends 'base.html' %}
{% load widget_tweaks %}
{% block title %}{% if object %}Editar Solicitação de Consulta{% else %}Nova Solicitação de Consulta{% endif %}{% endblock %}
{% block content %}
<div class="container py-4">
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">{% if object %}Editar{% else %}Nova{% endif %} Solicitação de Consulta</h5>
    </div>
    <div class="card-body">
      <form method="post">{% csrf_token %}
  <div id="consulta-alerta" class="alert alert-warning d-none" role="alert"></div>
  <div id="consulta-detalhes" class="alert alert-info d-none" role="alert"></div>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Paciente</label>
            <div class="position-relative mb-2">
              <input type="text" id="busca-paciente-regconsulta" class="form-control" placeholder="Digite nome, CPF ou CNS para buscar..." autocomplete="off" />
              <div id="resultado-paciente-regconsulta" class="list-group position-absolute w-100" style="z-index: 1000;"></div>
              <div class="form-text">Digite ao menos 2 letras e selecione o paciente; o campo abaixo será preenchido.</div>
            </div>
            {{ form.paciente|add_class:'form-select' }}
          </div>
          <div class="col-md-6">
            <label class="form-label">Especialidade</label>
            {{ form.especialidade|add_class:'form-select' }}
          </div>
          <div class="col-md-6">
            <label class="form-label">UBS Solicitante</label>
            {{ form.ubs_solicitante|add_class:'form-select' }}
          </div>
          <div class="col-md-6">
            <label class="form-label">Médico Solicitante</label>
            {{ form.medico_solicitante|add_class:'form-select' }}
          </div>
          <div class="col-12">
            <label class="form-label">Justificativa Clínica</label>
            {{ form.justificativa|add_class:'form-control' }}
          </div>
          <div class="col-md-4">
            <label class="form-label">Prioridade</label>
            {{ form.prioridade|add_class:'form-select' }}
          </div>
          <div class="col-12">
            <label class="form-label">Observações</label>
            {{ form.observacoes_solicitacao|add_class:'form-control' }}
          </div>
        </div>
        <div class="d-flex justify-content-end gap-2 mt-3">
          <a class="btn btn-secondary" href="{% url 'consulta-list' %}">Cancelar</a>
          <button class="btn btn-success" type="submit">Salvar</button>
        </div>
      </form>
    </div>
  </div>
</div>
  <script>
// Autocomplete de Paciente para Regulação de Consulta
document.addEventListener('DOMContentLoaded', function () {
  const input = document.getElementById('busca-paciente-regconsulta');
  const list = document.getElementById('resultado-paciente-regconsulta');
  const select = document.getElementById('id_paciente');
  const espec = document.getElementById('id_especialidade');
  const banner = document.getElementById('consulta-alerta');
  const detalhesBox = document.getElementById('consulta-detalhes');
  if (!input || !list || !select) return;

  let timer = null;

  function clearList(){ list.innerHTML = ''; list.style.display='none'; }
  function render(items){
    list.innerHTML = '';
    (items || []).forEach(item => {
      const a = document.createElement('a');
      a.href = '#'; a.className = 'list-group-item list-group-item-action';
      a.textContent = item.label || item.nome;
      a.addEventListener('click', (e)=>{
        e.preventDefault();
        select.innerHTML = '';
        const opt = document.createElement('option');
        opt.value = item.id; opt.textContent = item.nome; opt.selected = true;
        select.appendChild(opt);
        input.value = item.nome;
        clearList();
        // Atualizar aviso de consultas existentes
        try {
          if (banner){
            banner.classList.add('d-none');
            banner.textContent = '';
          }
          if (detalhesBox){
            detalhesBox.classList.add('d-none');
            detalhesBox.innerHTML = '';
          }
          const pid = parseInt(select.value, 10);
          const eid = espec ? parseInt(espec.value || '0', 10) : 0;
          if (!isNaN(pid) && pid > 0){
            const url = new URL('{% url "consulta-alertas" %}', window.location.origin);
            url.searchParams.set('paciente_id', String(pid));
            if (eid){ url.searchParams.set('especialidade_id', String(eid)); }
            fetch(url.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest' }})
              .then(r => r.ok ? r.json() : Promise.reject())
              .then(d => {
                if (!d || !d.ok || !banner) return;
                const fila = d.fila_count || 0;
                const ag = d.agendadas_count || 0;
                const same = d.same_especialidade;
                let parts = [];
                if (fila) parts.push(`${fila} em fila de espera`);
                if (ag) parts.push(`${ag} agendada(s)`);
                if (parts.length){
                  let msg = `Atenção: este paciente já possui ${parts.join(' e ')}.`;
                  if (same === true){ msg += ' Já existe solicitação nesta mesma especialidade.'; }
                  banner.textContent = msg;
                  banner.classList.remove('d-none');
                }
                const detalhes = Array.isArray(d.detalhes) ? d.detalhes : [];
                if (detalhes.length && detalhesBox){
                  detalhesBox.innerHTML = `<div><strong>Detalhes:</strong></div><ul class="mb-0">${detalhes.map(t => `<li>${t}</li>`).join('')}</ul>`;
                  detalhesBox.classList.remove('d-none');
                }
              })
              .catch(() => {});
          }
        } catch(err) {}
      });
      list.appendChild(a);
    });
    list.style.display = items && items.length ? 'block':'none';
  }
  function buscar(q){
    const url = new URL('{% url "paciente_autocomplete" %}', window.location.origin);
    url.searchParams.set('q', q); url.searchParams.set('limit','20');
    fetch(url.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
      .then(r => r.ok ? r.json() : Promise.reject())
      .then(d => render((d && d.results) || []))
      .catch(() => clearList());
  }
  input.addEventListener('input', function(){
    const q = (input.value||'').trim();
    clearTimeout(timer);
    if (q.length < 2){ clearList(); return; }
    timer = setTimeout(()=> buscar(q), 250);
  });
  document.addEventListener('click', function(e){
    if (!list.contains(e.target) && e.target !== input){ clearList(); }
  });
  // Atualizar banner ao mudar especialidade (se paciente já selecionado)
  if (espec){
    espec.addEventListener('change', function(){
      try {
  if (!banner) return;
        banner.classList.add('d-none');
        banner.textContent = '';
  if (detalhesBox){ detalhesBox.classList.add('d-none'); detalhesBox.innerHTML = ''; }
        const pid = parseInt(select.value || '0', 10);
        const eid = parseInt(espec.value || '0', 10);
        if (!pid) return;
        const url = new URL('{% url "consulta-alertas" %}', window.location.origin);
        url.searchParams.set('paciente_id', String(pid));
        if (eid){ url.searchParams.set('especialidade_id', String(eid)); }
        fetch(url.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest' }})
          .then(r => r.ok ? r.json() : Promise.reject())
          .then(d => {
            if (!d || !d.ok) return;
            const fila = d.fila_count || 0;
            const ag = d.agendadas_count || 0;
            const same = d.same_especialidade;
            let parts = [];
            if (fila) parts.push(`${fila} em fila de espera`);
            if (ag) parts.push(`${ag} agendada(s)`);
            if (parts.length){
              let msg = `Atenção: este paciente já possui ${parts.join(' e ')}.`;
              if (same === true){ msg += ' Já existe solicitação nesta mesma especialidade.'; }
              banner.textContent = msg;
              banner.classList.remove('d-none');
            }
            const detalhes = Array.isArray(d.detalhes) ? d.detalhes : [];
            if (detalhes.length && detalhesBox){
              detalhesBox.innerHTML = `<div><strong>Detalhes:</strong></div><ul class="mb-0">${detalhes.map(t => `<li>${t}</li>`).join('')}</ul>`;
              detalhesBox.classList.remove('d-none');
            }
          })
          .catch(() => {});
      } catch(err) {}
    });
  }
  // Se já houver paciente selecionado (edição), carregar alertas ao abrir
  try {
    const pid = parseInt(select.value || '0', 10);
    const eid = espec ? parseInt(espec.value || '0', 10) : 0;
    if (pid > 0){
      if (banner){ banner.classList.add('d-none'); banner.textContent = ''; }
      if (detalhesBox){ detalhesBox.classList.add('d-none'); detalhesBox.innerHTML = ''; }
      const url = new URL('{% url "consulta-alertas" %}', window.location.origin);
      url.searchParams.set('paciente_id', String(pid));
      if (eid){ url.searchParams.set('especialidade_id', String(eid)); }
      fetch(url.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest' }})
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(d => {
          if (!d || !d.ok) return;
          const fila = d.fila_count || 0;
          const ag = d.agendadas_count || 0;
          const same = d.same_especialidade;
          let parts = [];
          if (fila) parts.push(`${fila} em fila de espera`);
          if (ag) parts.push(`${ag} agendada(s)`);
          if (parts.length && banner){
            let msg = `Atenção: este paciente já possui ${parts.join(' e ')}.`;
            if (same === true){ msg += ' Já existe solicitação nesta mesma especialidade.'; }
            banner.textContent = msg;
            banner.classList.remove('d-none');
          }
          const detalhes = Array.isArray(d.detalhes) ? d.detalhes : [];
          if (detalhes.length && detalhesBox){
            detalhesBox.innerHTML = `<div><strong>Detalhes:</strong></div><ul class="mb-0">${detalhes.map(t => `<li>${t}</li>`).join('')}</ul>`;
            detalhesBox.classList.remove('d-none');
          }
        })
        .catch(()=>{});
    }
  } catch(err) {}
});
  </script>
{% endblock %}
