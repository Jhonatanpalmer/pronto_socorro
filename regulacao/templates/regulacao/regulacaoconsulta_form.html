{% extends 'base.html' %}
{% load widget_tweaks %}
{% block title %}{% if object %}Editar Solicitação de Consulta{% else %}Nova Solicitação de Consulta{% endif %}{% endblock %}
{% block content %}
<div class="container py-4">
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">{% if object %}Editar{% else %}Nova{% endif %} Solicitação de Consulta</h5>
    </div>
    <div class="card-body">
      <form method="post">{% csrf_token %}
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Paciente</label>
            <div class="position-relative mb-2">
              <input type="text" id="busca-paciente-regconsulta" class="form-control" placeholder="Digite nome, CPF ou CNS para buscar..." autocomplete="off" />
              <div id="resultado-paciente-regconsulta" class="list-group position-absolute w-100" style="z-index: 1000;"></div>
              <div class="form-text">Digite ao menos 2 letras e selecione o paciente; o campo abaixo será preenchido.</div>
            </div>
            {{ form.paciente|add_class:'form-select' }}
          </div>
          <div class="col-md-6">
            <label class="form-label">Especialidade</label>
            {{ form.especialidade|add_class:'form-select' }}
          </div>
          <div class="col-md-6">
            <label class="form-label">UBS Solicitante</label>
            {{ form.ubs_solicitante|add_class:'form-select' }}
          </div>
          <div class="col-md-6">
            <label class="form-label">Médico Solicitante</label>
            {{ form.medico_solicitante|add_class:'form-select' }}
          </div>
          <div class="col-12">
            <label class="form-label">Justificativa Clínica</label>
            {{ form.justificativa|add_class:'form-control' }}
          </div>
          <div class="col-md-4">
            <label class="form-label">Prioridade</label>
            {{ form.prioridade|add_class:'form-select' }}
          </div>
          <div class="col-12">
            <label class="form-label">Observações</label>
            {{ form.observacoes_solicitacao|add_class:'form-control' }}
          </div>
        </div>
        <div class="d-flex justify-content-end gap-2 mt-3">
          <a class="btn btn-secondary" href="{% url 'consulta-list' %}">Cancelar</a>
          <button class="btn btn-success" type="submit">Salvar</button>
        </div>
      </form>
    </div>
  </div>
</div>
  <script>
// Autocomplete de Paciente para Regulação de Consulta
document.addEventListener('DOMContentLoaded', function () {
  const input = document.getElementById('busca-paciente-regconsulta');
  const list = document.getElementById('resultado-paciente-regconsulta');
  const select = document.getElementById('id_paciente');
  if (!input || !list || !select) return;

  let timer = null;

  function clearList(){ list.innerHTML = ''; list.style.display='none'; }
  function render(items){
    list.innerHTML = '';
    (items || []).forEach(item => {
      const a = document.createElement('a');
      a.href = '#'; a.className = 'list-group-item list-group-item-action';
      a.textContent = item.label || item.nome;
      a.addEventListener('click', (e)=>{
        e.preventDefault();
        select.innerHTML = '';
        const opt = document.createElement('option');
        opt.value = item.id; opt.textContent = item.nome; opt.selected = true;
        select.appendChild(opt);
        input.value = item.nome;
        clearList();
      });
      list.appendChild(a);
    });
    list.style.display = items && items.length ? 'block':'none';
  }
  function buscar(q){
    const url = new URL('{% url "paciente_autocomplete" %}', window.location.origin);
    url.searchParams.set('q', q); url.searchParams.set('limit','20');
    fetch(url.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
      .then(r => r.ok ? r.json() : Promise.reject())
      .then(d => render((d && d.results) || []))
      .catch(() => clearList());
  }
  input.addEventListener('input', function(){
    const q = (input.value||'').trim();
    clearTimeout(timer);
    if (q.length < 2){ clearList(); return; }
    timer = setTimeout(()=> buscar(q), 250);
  });
  document.addEventListener('click', function(e){
    if (!list.contains(e.target) && e.target !== input){ clearList(); }
  });
});
  </script>
{% endblock %}
