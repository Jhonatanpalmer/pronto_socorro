{% extends 'base.html' %}

{% block title %}Regular Exame - Protocolo #{{ regulacao.numero_protocolo }}{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-10 col-lg-8">
            <!-- Informações da Solicitação -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h4 class="card-title mb-0">
                        <i class="bi bi-clipboard-data"></i>
                        Protocolo #{{ regulacao.numero_protocolo }}
                        <span class="badge {{ regulacao.get_status_badge_class }} ms-2">
                            {{ regulacao.get_status_display }}
                        </span>
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted">INFORMAÇÕES DO PACIENTE</h6>
                            <p class="mb-1"><strong>Nome:</strong> {{ regulacao.paciente.nome }}</p>
                            <p class="mb-1"><strong>CPF:</strong> {{ regulacao.paciente.cpf }}</p>
                            {% if regulacao.paciente.telefone %}
                            <p class="mb-1"><strong>Telefone:</strong> {{ regulacao.paciente.telefone }}</p>
                            {% endif %}
                            <p class="mb-3"><strong>Data Nascimento:</strong> {{ regulacao.paciente.data_nascimento|date:"d/m/Y" }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted">INFORMAÇÕES DA SOLICITAÇÃO</h6>
                            <p class="mb-1"><strong>UBS:</strong> {{ regulacao.ubs_solicitante.nome }}</p>
                            <p class="mb-1"><strong>Médico:</strong> {{ regulacao.medico_solicitante.nome }}</p>
                            <p class="mb-1"><strong>CRM:</strong> {{ regulacao.medico_solicitante.crm }}</p>
                            <p class="mb-3"><strong>Data Solicitação:</strong> {{ regulacao.data_solicitacao|date:"d/m/Y H:i" }}</p>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <h6 class="text-muted">EXAME SOLICITADO</h6>
                            <div class="alert alert-light">
                                <h5 class="mb-1">{{ regulacao.tipo_exame.nome }}</h5>
                                {% if regulacao.tipo_exame.codigo %}
                                <p class="mb-1"><strong>Código:</strong> {{ regulacao.tipo_exame.codigo }}</p>
                                {% endif %}
                                {% if regulacao.tipo_exame.descricao %}
                                <p class="mb-1"><strong>Descrição:</strong> {{ regulacao.tipo_exame.descricao }}</p>
                                {% endif %}
                                {% if regulacao.tipo_exame.valor %}
                                <p class="mb-0"><strong>Valor:</strong> R$ {{ regulacao.tipo_exame.valor|floatformat:2 }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted">PRIORIDADE</h6>
                            <p>
                                {% if regulacao.prioridade == 'alta' %}
                                <span class="badge bg-danger">Alta Prioridade</span>
                                {% elif regulacao.prioridade == 'media' %}
                                <span class="badge bg-warning">Média Prioridade</span>
                                {% else %}
                                <span class="badge bg-secondary">Prioridade Normal</span>
                                {% endif %}
                            </p>
                        </div>
                        {% if regulacao.observacoes_solicitacao %}
                        <div class="col-md-6">
                            <h6 class="text-muted">OBSERVAÇÕES DA SOLICITAÇÃO</h6>
                            <p>{{ regulacao.observacoes_solicitacao }}</p>
                        </div>
                        {% endif %}
                    </div>

                    {# Mostrar informações da regulação apenas quando já houve decisão #}
                    {% if regulacao.status == 'autorizado' or regulacao.status == 'negado' or regulacao.status == 'cancelado' or regulacao.regulador or regulacao.data_regulacao %}
                    <hr>
                    <div class="row">
                        <div class="col-12">
                            <h6 class="text-muted">INFORMAÇÕES DA REGULAÇÃO</h6>
                            {% if regulacao.regulador %}
                            <p class="mb-1"><strong>Regulado por:</strong> {% firstof regulacao.regulador.get_full_name regulacao.regulador.username %}</p>
                            {% endif %}
                            <p class="mb-1"><strong>Data da Regulação:</strong> {{ regulacao.data_regulacao|date:"d/m/Y H:i" }}</p>
                            {% if regulacao.motivo_decisao %}
                            <p class="mb-0"><strong>Motivo da Decisão:</strong> {{ regulacao.motivo_decisao }}</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Formulário de Regulação -->
            {% if regulacao.status == 'pendente' or regulacao.status == 'fila' %}
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-gear-fill"></i>
                        Realizar Regulação
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label for="decisao" class="form-label">
                                <strong>Decisão <span class="text-danger">*</span></strong>
                            </label>
                            <div class="btn-group w-100" role="group" aria-label="Decisão de regulação">
                                <input type="radio" class="btn-check" name="decisao" id="autorizar" value="autorizado" required {% if decisao == 'autorizado' %}checked{% endif %}>
                                <label class="btn btn-outline-success" for="autorizar">
                                    <i class="bi bi-check-circle-fill"></i> Autorizar
                                </label>
                                
                                <input type="radio" class="btn-check" name="decisao" id="negar" value="negado" required {% if decisao == 'negado' %}checked{% endif %}>
                                <label class="btn btn-outline-danger" for="negar">
                                    <i class="bi bi-x-circle-fill"></i> Negar
                                </label>
                            </div>
                        </div>

                        <div id="campos-autorizacao" style="display:none;">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Local de Realização</label>
                                    <input type="text" class="form-control" name="local_realizacao" value="{{ request.POST.local_realizacao|default:regulacao.local_realizacao }}" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Data do Agendamento</label>
                                    <input type="date" class="form-control" name="data_agendada" value="{{ request.POST.data_agendada|default:regulacao.data_agendada|date:'Y-m-d' }}" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Hora</label>
                                    <input type="time" class="form-control" name="hora_agendada" value="{{ request.POST.hora_agendada|default:regulacao.hora_agendada|time:'H:i' }}" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Médico Atendente</label>
                                    <select class="form-select" name="medico_atendente">
                                        <option value="">Selecione...</option>
                                        {% for m in medicos %}
                                        <option value="{{ m.id }}" {% if request.POST.medico_atendente == m.id|stringformat:'s' or regulacao.medico_atendente_id == m.id %}selected{% endif %}>{{ m.nome }} (CRM {{ m.crm }})</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="mt-3">
                                <label class="form-label">Observações da Regulação</label>
                                <textarea class="form-control" name="observacoes_regulacao" rows="2">{{ regulacao.observacoes_regulacao }}</textarea>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="justificativa" class="form-label">
                                <strong>Justificativa <span class="text-danger">*</span></strong>
                            </label>
                            <textarea name="justificativa" id="justificativa" rows="4" class="form-control" 
                                      placeholder="Digite a justificativa para sua decisão..." required>{{ request.POST.justificativa }}</textarea>
                            <div class="form-text">
                                Explique os motivos que levaram à sua decisão de autorizar ou negar o exame.
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'regulacao-list' %}" class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i> Voltar à Lista
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-lg"></i> Confirmar Regulação
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            {% else %}
            <!-- Se já foi regulado, mostrar apenas botão de voltar -->
            <div class="text-center">
                <a href="{% url 'regulacao-list' %}" class="btn btn-primary">
                    <i class="bi bi-arrow-left"></i> Voltar à Lista
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

<script>
// Mostra os campos de autorização quando a decisão é 'autorizado'
document.addEventListener('DOMContentLoaded', function(){
    const autorizar = document.getElementById('autorizar');
    const negar = document.getElementById('negar');
    const bloco = document.getElementById('campos-autorizacao');
    const reqFields = [
        'input[name="local_realizacao"]',
        'input[name="data_agendada"]',
        'input[name="hora_agendada"]',
        'select[name="medico_atendente"]'
    ].map(s => document.querySelector(s));
        function toggle(){
            const on = autorizar && autorizar.checked;
        bloco.style.display = on ? 'block' : 'none';
        reqFields.forEach(el => { if (el){ el.required = on; el.disabled = !on; }});
    }
    if (autorizar) autorizar.addEventListener('change', toggle);
    if (negar) negar.addEventListener('change', toggle);
        // se houve POST e a decisão foi 'autorizado', garantir exibição
        {% if decisao == 'autorizado' %}
            if (autorizar) autorizar.checked = true;
        {% endif %}
        toggle();
});
</script>