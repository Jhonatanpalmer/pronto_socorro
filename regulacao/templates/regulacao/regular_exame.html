{% extends 'base.html' %}

{% block title %}Regular Exame - Protocolo #{{ regulacao.numero_protocolo }}{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-11 col-lg-10">
            <!-- Cabeçalho / Resumo -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
                        <h4 class="card-title mb-0 d-flex align-items-center gap-2">
                            <i class="bi bi-clipboard-data"></i>
                            Protocolo #{{ regulacao.numero_protocolo }}
                        </h4>
                        <span class="badge {{ regulacao.get_status_badge_class }}">{{ regulacao.get_status_display }}</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <h6 class="text-muted">Paciente</h6>
                            <div class="d-flex flex-column small">
                                <span><strong>Nome:</strong> {{ regulacao.paciente.nome }}</span>
                                <span><strong>CPF:</strong> {{ regulacao.paciente.cpf }}</span>
                                {% if regulacao.paciente.telefone %}
                                    <span><strong>Telefone:</strong> {{ regulacao.paciente.telefone }}</span>
                                {% endif %}
                                <span><strong>Nascimento:</strong> {{ regulacao.paciente.data_nascimento|date:"d/m/Y" }}</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted">Solicitação</h6>
                            <div class="d-flex flex-column small">
                                <span><strong>UBS:</strong> {{ regulacao.ubs_solicitante.nome }}</span>
                                <span><strong>Médico:</strong> {{ regulacao.medico_solicitante.nome }} (CRM {{ regulacao.medico_solicitante.crm }})</span>
                                <span><strong>Solicitado em:</strong> {{ regulacao.data_solicitacao|date:"d/m/Y H:i" }}</span>
                            </div>
                        </div>
                        <div class="col-12">
                            <h6 class="text-muted">Exame solicitado</h6>
                            <div class="alert alert-light mb-0">
                                <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
                                    <h5 class="mb-0">{{ regulacao.tipo_exame.nome }}</h5>
                                    <div class="d-flex flex-wrap gap-2">
                                        {% if regulacao.prioridade == 'alta' %}
                                            <span class="badge bg-danger">Alta</span>
                                        {% elif regulacao.prioridade == 'media' %}
                                            <span class="badge bg-warning text-dark">Média</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Normal</span>
                                        {% endif %}
                                        {% if regulacao.tipo_exame.codigo %}
                                            <span class="badge bg-light text-secondary border">Cód: {{ regulacao.tipo_exame.codigo }}</span>
                                        {% endif %}
                                        {% if regulacao.tipo_exame.valor %}
                                            <span class="badge bg-light text-secondary border">R$ {{ regulacao.tipo_exame.valor|floatformat:2 }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% if regulacao.tipo_exame.descricao %}
                                    <div class="mt-2 small text-muted">{{ regulacao.tipo_exame.descricao }}</div>
                                {% endif %}
                                {% if regulacao.observacoes_solicitacao %}
                                    <div class="mt-2"><strong>Observações:</strong> {{ regulacao.observacoes_solicitacao }}</div>
                                {% endif %}
                            </div>
                        </div>
                        {% if regulacao.status in 'autorizado,negado,cancelado' or regulacao.regulador or regulacao.data_regulacao %}
                        <div class="col-12">
                            <hr class="my-2">
                            <h6 class="text-muted">Regulação</h6>
                            <div class="small">
                                {% if regulacao.regulador %}
                                    <div><strong>Regulado por:</strong> {% firstof regulacao.regulador.get_full_name regulacao.regulador.username %}</div>
                                {% endif %}
                                <div><strong>Data:</strong> {{ regulacao.data_regulacao|date:"d/m/Y H:i" }}</div>
                                {% if regulacao.motivo_decisao %}
                                    <div><strong>Motivo:</strong> {{ regulacao.motivo_decisao }}</div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            {% if regulacao.status == 'pendente' or regulacao.status == 'fila' %}
            <!-- Formulário de Regulação -->
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0 d-flex align-items-center gap-2">
                        <i class="bi bi-gear-fill"></i>
                        Realizar Regulação
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="form-regular-exame">
                        {% csrf_token %}

                        <!-- Decisão destacada em cartões grandes -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">Decisão <span class="text-danger">*</span></label>
                            <div class="row g-3">
                                <div class="col-12 col-lg-6">
                                    <input type="radio" class="btn-check" name="decisao" id="autorizar" value="autorizado" required {% if decisao == 'autorizado' %}checked{% endif %}>
                                    <label class="btn w-100 p-3 border rounded-3 text-start d-flex align-items-center gap-3 btn-outline-success" for="autorizar">
                                        <span class="display-6"><i class="bi bi-check-circle-fill text-success"></i></span>
                                        <span>
                                            <span class="h5 mb-1 d-block">Autorizar</span>
                                            <small class="text-muted">Abrirá os campos para definir local, data e médico.</small>
                                        </span>
                                    </label>
                                </div>
                                <div class="col-12 col-lg-6">
                                    <input type="radio" class="btn-check" name="decisao" id="negar" value="negado" required {% if decisao == 'negado' %}checked{% endif %}>
                                    <label class="btn w-100 p-3 border rounded-3 text-start d-flex align-items-center gap-3 btn-outline-danger" for="negar">
                                        <span class="display-6"><i class="bi bi-x-circle-fill text-danger"></i></span>
                                        <span>
                                            <span class="h5 mb-1 d-block">Negar</span>
                                            <small class="text-muted">Será solicitado o motivo da negação.</small>
                                        </span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Campos quando autorizado -->
                        <div id="campos-autorizacao" class="border rounded-3 p-3 mb-4" style="display:none;">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Local de Realização <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="local_realizacao" placeholder="Ex.: Clínica ABC" value="{{ request.POST.local_realizacao|default:regulacao.local_realizacao }}" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Data do Agendamento <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" name="data_agendada" value="{{ request.POST.data_agendada|default:regulacao.data_agendada|date:'Y-m-d' }}" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Hora <span class="text-danger">*</span></label>
                                    <input type="time" class="form-control" name="hora_agendada" value="{{ request.POST.hora_agendada|default:regulacao.hora_agendada|time:'H:i' }}" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Médico Atendente <span class="text-danger">*</span></label>
                                    <select class="form-select" name="medico_atendente">
                                        <option value="">Selecione...</option>
                                        {% for m in medicos %}
                                            <option value="{{ m.id }}" {% if request.POST.medico_atendente == m.id|stringformat:'s' or regulacao.medico_atendente_id == m.id %}selected{% endif %}>{{ m.nome }} (CRM {{ m.crm }})</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Observações da Regulação</label>
                                    <textarea class="form-control" name="observacoes_regulacao" rows="2" placeholder="Informações adicionais">{{ regulacao.observacoes_regulacao }}</textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Justificativa -->
                        <div class="mb-4">
                            <label for="justificativa" class="form-label fw-semibold">Justificativa <span class="text-danger">*</span></label>
                            <textarea name="justificativa" id="justificativa" rows="4" class="form-control" placeholder="Descreva os motivos da decisão" required>{{ request.POST.justificativa }}</textarea>
                            <div class="form-text">Explique os motivos que levaram à sua decisão.</div>
                        </div>

                        <div class="d-grid gap-2 d-sm-flex justify-content-sm-end">
                            <a href="{% url 'regulacao-list' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> Voltar à lista
                            </a>
                            <button type="submit" class="btn btn-primary px-4">
                                <i class="bi bi-check2-circle"></i> Confirmar regulação
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            {% else %}
            <div class="text-center">
                <a href="{% url 'regulacao-list' %}" class="btn btn-primary">
                    <i class="bi bi-arrow-left"></i> Voltar à Lista
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

<!-- Modal de confirmação para negação -->
<div class="modal fade" id="modalNegar" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>Confirmar negação</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Tem certeza que deseja negar este exame? Certifique-se de preencher a justificativa com os motivos.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Voltar</button>
                <button type="button" class="btn btn-danger" id="confirmNegarBtn">Negar exame</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
    const autorizar = document.getElementById('autorizar');
    const negar = document.getElementById('negar');
    const bloco = document.getElementById('campos-autorizacao');
    const form = document.getElementById('form-regular-exame');
    const reqFields = [
        'input[name="local_realizacao"]',
        'input[name="data_agendada"]',
        'input[name="hora_agendada"]',
        'select[name="medico_atendente"]'
    ].map(s => document.querySelector(s));

    function toggle(){
        const on = autorizar && autorizar.checked;
        if (bloco) bloco.style.display = on ? 'block' : 'none';
        reqFields.forEach(el => { if (el){ el.required = on; el.disabled = !on; }});
    }
    if (autorizar) autorizar.addEventListener('change', toggle);
    if (negar) negar.addEventListener('change', toggle);
    {% if decisao == 'autorizado' %}
        if (autorizar) autorizar.checked = true;
    {% endif %}
    toggle();

    // Confirmação ao negar
    if (form) {
        form.addEventListener('submit', function(e){
            if (negar && negar.checked) {
                e.preventDefault();
                const modalEl = document.getElementById('modalNegar');
                if (modalEl) {
                    const modal = new bootstrap.Modal(modalEl);
                    modal.show();
                    const confirmBtn = document.getElementById('confirmNegarBtn');
                    const onConfirm = () => {
                        confirmBtn.removeEventListener('click', onConfirm);
                        modal.hide();
                        form.submit();
                    };
                    confirmBtn.addEventListener('click', onConfirm);
                }
            }
        });
    }
});
</script>