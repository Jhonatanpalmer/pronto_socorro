{% extends 'base.html' %}
{% block title %}Consultas - Regulação{% endblock %}
{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>Solicitações de Consultas</h4>
    <a class="btn btn-primary" href="{% url 'consulta-create' %}">Nova Solicitação</a>
  </div>
  <div class="card mb-3">
    <div class="card-body py-2">
      <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
        <strong>Status:</strong>
        <a href="{% url 'consulta-list' %}" class="btn btn-sm {% if not current_status %}btn-primary{% else %}btn-outline-primary{% endif %}">Todos</a>
        <a href="{% url 'consulta-list' %}?status=fila" class="btn btn-sm {% if current_status == 'fila' %}btn-primary{% else %}btn-outline-primary{% endif %}">Fila de Espera</a>
        <a href="{% url 'consulta-list' %}?status=autorizado" class="btn btn-sm {% if current_status == 'autorizado' %}btn-primary{% else %}btn-outline-primary{% endif %}">Autorizados</a>
        <a href="{% url 'consulta-list' %}?status=agendados" class="btn btn-sm {% if current_status == 'agendados' %}btn-primary{% else %}btn-outline-primary{% endif %}">Agendados</a>
        <a href="{% url 'consulta-list' %}?status=negado" class="btn btn-sm {% if current_status == 'negado' %}btn-primary{% else %}btn-outline-primary{% endif %}">Negados</a>
      </div>
      <form method="get" class="row g-2 align-items-end">
        <div class="col-12 col-md-4">
          <label class="form-label form-label-sm">UBS</label>
          <select name="ubs" class="form-select form-select-sm" onchange="this.form.submit()">
            <option value="">Todas</option>
            {% for u in ubs_list %}
              <option value="{{ u.id }}" {% if current_ubs|default:'' == u.id|stringformat:'s' %}selected{% endif %}>{{ u.nome }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label form-label-sm">Especialidade</label>
          <select name="especialidade" class="form-select form-select-sm" onchange="this.form.submit()">
            <option value="">Todas</option>
            {% for e in especialidades %}
              <option value="{{ e.id }}" {% if current_especialidade|default:'' == e.id|stringformat:'s' %}selected{% endif %}>{{ e.nome }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label form-label-sm">Paciente (nome, CPF ou CNS)</label>
          <div class="input-group input-group-sm">
            <input type="text" name="q" class="form-control" value="{{ q }}" placeholder="Buscar paciente...">
            <button class="btn btn-outline-secondary" type="submit">Filtrar</button>
          </div>
        </div>
        <input type="hidden" name="status" value="{{ current_status }}" />
      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-body p-0">
      <table class="table mb-0">
        <thead>
          <tr>
            <th>Protocolo</th>
            <th>Paciente</th>
            <th>Especialidade</th>
            <th>UBS</th>
            <th>Status</th>
            <th>Situação</th>
            <th>Solicitado em</th>
            <th class="text-end">Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for r in solicitacoes %}
          <tr>
            <td>{{ r.numero_protocolo }}</td>
            <td>{{ r.paciente.nome }}</td>
            <td>{{ r.especialidade.nome }}</td>
            <td>{{ r.ubs_solicitante.nome }}</td>
            <td><span class="badge {{ r.get_status_badge_class }}">{{ r.get_status_display }}</span></td>
            <td>
              {% if r.status == 'autorizado' and r.data_agendada %}
                {% if r.data_agendada < hoje %}
                  <span class="badge bg-danger" title="Agendada no passado">Vencida</span>
                {% else %}
                  <span class="badge bg-success" title="Agendada para hoje ou futuro">Futuro</span>
                {% endif %}
              {% elif r.status == 'fila' %}
                <span class="badge bg-info text-dark">Fila</span>
              {% elif r.status == 'pendente' %}
                <span class="badge bg-warning text-dark">Pendente</span>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
            <td>{{ r.data_solicitacao|date:'d/m/Y H:i' }}</td>
            <td class="text-end">
              {% if r.status == 'fila' or r.status == 'pendente' %}
                <a class="btn btn-sm btn-warning" href="{% url 'regular-consulta' r.pk %}">Regular</a>
              {% endif %}
              <a class="btn btn-sm btn-outline-secondary" href="{% url 'consulta-update' r.pk %}">Editar</a>
              <a class="btn btn-sm btn-outline-danger" href="{% url 'consulta-delete' r.pk %}">Excluir</a>
              <a class="btn btn-sm btn-outline-primary" href="{% url 'paciente_historico' r.paciente_id %}"><i class="bi bi-clock-history"></i> Histórico</a>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="7" class="text-center py-3">Nenhuma solicitação encontrada.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
