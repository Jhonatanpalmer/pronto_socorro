{% extends 'base.html' %}
{% load widget_tweaks %}

{% block title %}Lista de Viagens{% endblock %}

{% block content %}
<style>
/* Estilos específicos para impressão */
@media print {
  @page {
      margin: 12mm;
  }
  body {
      margin: 0;
      padding: 0;
      background: #fff;
  }
  .no-print,
  .navbar,
  .sidebar,
  .btn,
  .modal,
  .modal-backdrop {
      display: none !important;
  }
  .container {
      max-width: 100% !important;
  }
  .print-area {
      box-shadow: none !important;
      border-radius: 0;
  }
  .table-responsive {
      overflow: visible !important;
  }
  table {
      border-collapse: collapse !important;
      width: 100%;
      font-size: 12px;
      table-layout: fixed;
  }
  th, td {
      border: 1px solid #000 !important;
      padding: 4px;
      text-align: center;
  }
  thead th {
      background: #0d6efd !important;
      color: #fff !important;
      font-weight: 700;
      white-space: nowrap;
  }
  tbody td {
      font-weight: 700;
      word-break: break-word;
  }
  .report-header {
      text-align: center;
      margin-bottom: 15px;
  }
  .report-header h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
  }
  .report-header small {
      font-size: 12px;
      color: #555;
      font-weight: 700;
  }
}
</style>

<div class="container py-4 py-md-5">
    <!-- Hero -->
    <div class="p-4 p-md-5 rounded-3 mb-4 no-print" style="background-image: linear-gradient(90deg, #0d6efd 0%, #20c997 100%); box-shadow: 0 8px 24px rgba(13,110,253,.25);">
        <div class="d-flex flex-column flex-md-row align-items-md-center gap-3 text-white">
            <div class="display-6"><i class="bi bi-truck"></i></div>
            <div class="flex-grow-1">
                <h2 class="fw-bold mb-1">Viagens</h2>
                <div class="text-white-50">Acompanhe as viagens registradas</div>
            </div>
            <div class="d-flex flex-wrap gap-2 justify-content-end">
                <a href="{% url 'viagem-create' %}" class="btn btn-light text-primary"><i class="bi bi-plus-lg"></i> Nova Viagem</a>
                <button class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#modalTipoAtendimento">
                    <i class="bi bi-journal-plus"></i> Tipo de Atendimento
                </button>
                <button class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#modalHospital">
                    <i class="bi bi-hospital"></i> Hospital de Atendimento
                </button>
                <button class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#modalDestino">
                    <i class="bi bi-geo-alt"></i> Cidade de Destino
                </button>
                <a href="{% url 'viagem-list' %}" class="btn btn-outline-light">Atualizar</a>
                <a href="javascript:window.print()" class="btn btn-outline-light"><i class="bi bi-printer-fill"></i> Imprimir</a>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card shadow-sm mb-4 no-print border-0">
        <div class="card-header bg-light">
            <h6 class="mb-0"><i class="bi bi-funnel me-1"></i> Filtros</h6>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3 align-items-end">
                <div class="col-sm-6 col-md-3">
                    <label class="form-label small">De</label>
                    <input class="form-control form-control-sm" type="date" name="start" value="{{ filter_start }}">
                </div>
                <div class="col-sm-6 col-md-3">
                    <label class="form-label small">Até</label>
                    <input class="form-control form-control-sm" type="date" name="end" value="{{ filter_end }}">
                </div>
                <div class="col-sm-6 col-md-4 col-lg-3">
                    <label class="form-label small">Destino</label>
                    <select class="form-select form-select-sm" name="destino">
                        <option value="">Todos</option>
                        {% for destino in destinos_disponiveis %}
                            <option value="{{ destino }}" {% if destino == filter_destino %}selected{% endif %}>{{ destino }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-primary btn-sm"><i class="bi bi-search"></i> Pesquisar</button>
                    <a href="{% url 'viagem-list' %}" class="btn btn-outline-secondary btn-sm ms-2">Limpar</a>
                </div>
            </form>
        </div>
    </div>

    {% if viagens %}
        <div class="print-area">
            <!-- Cabeçalho visível só na impressão -->
            <div class="report-header">
                <h2>Relatório de Viagens</h2>
                <small>Emitido em: {{ today|date:"d/m/Y" }}</small>
            </div>

            <div class="table-responsive shadow-sm rounded-3">
                <table class="table table-hover align-middle mb-0">
                    <colgroup>
                        <col style="width: 7%">
                        <col style="width: 9%">
                        <col style="width: 10%">
                        <col style="width: 6%">
                        <col style="width: 11%">
                        <col style="width: 11%">
                        <col style="width: 9%">
                        <col style="width: 9%">
                        <col style="width: 7%">
                        <col style="width: 8%">
                        <col style="width: 8%">
                        <col style="width: 8%">
                    </colgroup>
                    <thead class="table-light">
                        <tr class="text-center text-uppercase">
                            <th class="fw-bold">Data</th>
                            <th class="fw-bold">Veículo</th>
                            <th class="fw-bold">Motorista</th>
                            <th class="fw-bold">Horário</th>
                            <th class="fw-bold">Nome do Paciente</th>
                            <th class="fw-bold">Endereço</th>
                            <th class="fw-bold">Destino</th>
                            <th class="fw-bold">Acompanhante</th>
                            <th class="fw-bold">CPF</th>
                            <th class="fw-bold">Telefone</th>
                            <th class="fw-bold">Tipo</th>
                            <th class="fw-bold">Hospital</th>
                            <th class="no-print">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for viagem in viagens %}
                            <tr>
                                <td class="text-center fw-bold">{{ viagem.data_viagem|date:"d/m/Y" }}</td>
                                <td class="text-center fw-bold">{{ viagem.veiculo }}</td>
                                <td class="text-center fw-bold">{{ viagem.motorista_nome }}</td>
                                <td class="text-center fw-bold">{{ viagem.hora_saida|time:"H:i" }}</td>
                                <td class="fw-bold">{{ viagem.paciente.nome }}</td>
                                <td class="text-start fw-bold">{{ viagem.endereco_paciente }}</td>
                                <td class="text-start fw-bold">{{ viagem.destino }}</td>
                                <td class="fw-bold">{{ viagem.acompanhante }}</td>
                                <td class="text-center fw-bold">{{ viagem.paciente.cpf }}</td>
                                <td class="text-center fw-bold">{{ viagem.paciente.telefone }}</td>
                                <td class="fw-bold">{{ viagem.tipo_atendimento }}</td>
                                <td class="fw-bold">{{ viagem.hospital }}</td>
                                <td class="no-print text-center">
                                    <a href="{% url 'viagem-edit' viagem.pk %}" class="btn btn-sm btn-primary">Editar</a>
                                    <form method="post" action="{% url 'viagem-delete' viagem.pk %}" style="display:inline" onsubmit="return confirm('Tem certeza que deseja excluir a viagem de {{ viagem.paciente.nome|escapejs }} para {{ viagem.destino|escapejs }} em {{ viagem.data_viagem|date:"d/m/Y" }}?')">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-danger">Excluir</button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% else %}
        <div class="alert alert-warning text-center mt-4 shadow-sm" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i> Nenhuma viagem encontrada.
        </div>
    {% endif %}
</div>

<!-- Modal: Tipo de Atendimento -->
<div class="modal fade" id="modalTipoAtendimento" tabindex="-1" aria-labelledby="modalTipoAtendimentoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTipoAtendimentoLabel"><i class="bi bi-journal-plus me-2"></i>Cadastro de Tipo de Atendimento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <form method="post" class="mb-4">
                    {% csrf_token %}
                    <input type="hidden" name="_action" value="tipo-atendimento">
                    {% if tipo_atendimento_form.non_field_errors %}
                        <div class="alert alert-danger small mb-3">{{ tipo_atendimento_form.non_field_errors|join:', ' }}</div>
                    {% endif %}
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label small text-muted">Nome *</label>
                            {{ tipo_atendimento_form.nome|add_class:"form-control" }}
                            {% if tipo_atendimento_form.nome.errors %}
                                <div class="text-danger small mt-1">{{ tipo_atendimento_form.nome.errors|join:', ' }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-12">
                            <label class="form-label small text-muted">Descrição</label>
                            {{ tipo_atendimento_form.descricao|add_class:"form-control" }}
                            {% if tipo_atendimento_form.descricao.errors %}
                                <div class="text-danger small mt-1">{{ tipo_atendimento_form.descricao.errors|join:', ' }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4 d-flex align-items-center">
                            <div class="form-check form-switch">
                                {{ tipo_atendimento_form.ativo|add_class:"form-check-input" }}
                                <label class="form-check-label" for="{{ tipo_atendimento_form.ativo.id_for_label }}">Ativo</label>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Salvar tipo</button>
                    </div>
                </form>

                <h6 class="small text-uppercase text-muted mb-2">Tipos cadastrados</h6>
                <div class="border rounded overflow-hidden">
                    <ul class="list-group list-group-flush">
                        {% for tipo in tipos_atendimento %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>{{ tipo.nome }}</span>
                                {% if not tipo.ativo %}
                                    <span class="badge bg-secondary">Inativo</span>
                                {% endif %}
                            </li>
                        {% empty %}
                            <li class="list-group-item text-muted fst-italic">Nenhum tipo cadastrado.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Hospital de Atendimento -->
<div class="modal fade" id="modalHospital" tabindex="-1" aria-labelledby="modalHospitalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalHospitalLabel"><i class="bi bi-hospital me-2"></i>Cadastro de Hospital de Atendimento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <form method="post" class="mb-4">
                    {% csrf_token %}
                    <input type="hidden" name="_action" value="hospital-atendimento">
                    {% if hospital_atendimento_form.non_field_errors %}
                        <div class="alert alert-danger small mb-3">{{ hospital_atendimento_form.non_field_errors|join:', ' }}</div>
                    {% endif %}
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label small text-muted">Nome *</label>
                            {{ hospital_atendimento_form.nome|add_class:"form-control" }}
                            {% if hospital_atendimento_form.nome.errors %}
                                <div class="text-danger small mt-1">{{ hospital_atendimento_form.nome.errors|join:', ' }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-12">
                            <label class="form-label small text-muted">Descrição</label>
                            {{ hospital_atendimento_form.descricao|add_class:"form-control" }}
                            {% if hospital_atendimento_form.descricao.errors %}
                                <div class="text-danger small mt-1">{{ hospital_atendimento_form.descricao.errors|join:', ' }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4 d-flex align-items-center">
                            <div class="form-check form-switch">
                                {{ hospital_atendimento_form.ativo|add_class:"form-check-input" }}
                                <label class="form-check-label" for="{{ hospital_atendimento_form.ativo.id_for_label }}">Ativo</label>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Salvar hospital</button>
                    </div>
                </form>

                <h6 class="small text-uppercase text-muted mb-2">Hospitais cadastrados</h6>
                <div class="border rounded overflow-hidden">
                    <ul class="list-group list-group-flush">
                        {% for hospital_opcao in hospitais_atendimento %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>{{ hospital_opcao.nome }}</span>
                                {% if not hospital_opcao.ativo %}
                                    <span class="badge bg-secondary">Inativo</span>
                                {% endif %}
                            </li>
                        {% empty %}
                            <li class="list-group-item text-muted fst-italic">Nenhum hospital cadastrado.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Cidade de Destino -->
<div class="modal fade" id="modalDestino" tabindex="-1" aria-labelledby="modalDestinoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalDestinoLabel"><i class="bi bi-geo-alt me-2"></i>Cadastro de Cidade de Destino</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <form method="post" class="mb-4">
                    {% csrf_token %}
                    <input type="hidden" name="_action" value="destino">
                    {% if destino_form.non_field_errors %}
                        <div class="alert alert-danger small mb-3">{{ destino_form.non_field_errors|join:', ' }}</div>
                    {% endif %}
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label small text-muted">Cidade *</label>
                            {{ destino_form.nome_cidade|add_class:"form-control" }}
                            {% if destino_form.nome_cidade.errors %}
                                <div class="text-danger small mt-1">{{ destino_form.nome_cidade.errors|join:', ' }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small text-muted">UF *</label>
                            {{ destino_form.uf|add_class:"form-control text-uppercase" }}
                            {% if destino_form.uf.errors %}
                                <div class="text-danger small mt-1">{{ destino_form.uf.errors|join:', ' }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4 d-flex align-items-center">
                            <div class="form-check form-switch">
                                {{ destino_form.ativo|add_class:"form-check-input" }}
                                <label class="form-check-label" for="{{ destino_form.ativo.id_for_label }}">Ativo</label>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Salvar cidade</button>
                    </div>
                </form>

                <h6 class="small text-uppercase text-muted mb-2">Cidades cadastradas</h6>
                <div class="border rounded overflow-hidden" style="max-height: 300px; overflow-y: auto;">
                    <ul class="list-group list-group-flush">
                        {% for destino in destinos_viagem %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>{{ destino.nome_cidade }}/{{ destino.uf }}</span>
                                {% if not destino.ativo %}
                                    <span class="badge bg-secondary">Inativa</span>
                                {% endif %}
                            </li>
                        {% empty %}
                            <li class="list-group-item text-muted fst-italic">Nenhuma cidade cadastrada.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

{% if tipo_atendimento_form.errors %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const modalElement = document.getElementById('modalTipoAtendimento');
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
    });
</script>
{% endif %}
{% if hospital_atendimento_form.errors %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const modalElement = document.getElementById('modalHospital');
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
    });
</script>
{% endif %}
{% if destino_form.errors %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const modalElement = document.getElementById('modalDestino');
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
    });
</script>
{% endif %}
{% endblock %}
