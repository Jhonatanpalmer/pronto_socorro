{% extends 'base.html' %}

{% block title %}Histórico do Paciente — {{ paciente.nome }}{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h4 class="mb-1"><i class="bi bi-clock-history"></i> Histórico do Paciente — {{ paciente.nome }}</h4>
      <div class="text-muted small">
        {% if paciente.cns %}<span class="me-3">CNS: {{ paciente.cns }}</span>{% endif %}
        {% if paciente.data_nascimento %}<span class="me-3">Nascimento: {{ paciente.data_nascimento|date:'d/m/Y' }}</span>{% endif %}
      </div>
    </div>
  </div>

  <form method="get" class="row g-3 align-items-end mb-4">
    <div class="col-md-3">
      <label class="form-label">Início</label>
      <input type="date" name="inicio" class="form-control" value="{{ inicio }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">Fim</label>
      <input type="date" name="fim" class="form-control" value="{{ fim }}">
    </div>
    <div class="col-md-4">
      <label class="form-label">Buscar</label>
      <input type="text" name="q" class="form-control" value="{{ q }}" placeholder="Ex: destino, especialidade, exame, UBS, observações...">
    </div>
    <div class="col-md-2 d-grid">
      <button class="btn btn-primary" type="submit"><i class="bi bi-funnel"></i> Filtrar</button>
    </div>
  </form>

  <!-- Exames -->
  <div class="card mb-4" id="sec-exames">
    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center gap-2">
        <strong>Exames</strong>
        {% if ex_aut_ids_csv %}
          <a href="{% url 'comprovantes-exames' %}?ids={{ ex_aut_ids_csv }}" target="_blank" class="btn btn-sm btn-outline-primary d-print-none" title="Imprimir todos os exames autorizados do histórico">
            <i class="bi bi-printer-fill"></i>
          </a>
        {% endif %}
      </div>
      {% if ex_print_groups %}
      <div class="dropdown d-print-none">
        <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-printer"></i> Imprimir do dia
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          {% for g in ex_print_groups %}
          <li>
            <a class="dropdown-item" href="{% url 'comprovantes-exames' %}?ids={{ g.ids_csv }}" target="_blank">
              {{ g.date|date:'d/m/Y' }} — {{ g.count }} exame(s)
            </a>
          </li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
    </div>
    <div class="card-body">
      <form method="get" class="row g-2 align-items-end mb-3">
        <input type="hidden" name="inicio" value="{{ inicio }}" />
        <input type="hidden" name="fim" value="{{ fim }}" />
        <input type="hidden" name="q" value="{{ q }}" />
        <!-- preservar filtros da outra seção -->
        <input type="hidden" name="status_co" value="{{ status_co }}" />
        <input type="hidden" name="ubs_co" value="{{ ubs_co }}" />
        <input type="hidden" name="especialidade_co" value="{{ especialidade_co }}" />
        <div class="col-md-3">
          <label class="form-label">Status</label>
          <select name="status_ex" class="form-select">
            <option value="" {% if not status_ex %}selected{% endif %}>Todos</option>
            <option value="fila" {% if status_ex == 'fila' %}selected{% endif %}>Fila</option>
            <option value="pendente" {% if status_ex == 'pendente' %}selected{% endif %}>Pendente</option>
            <option value="autorizado" {% if status_ex == 'autorizado' %}selected{% endif %}>Autorizado</option>
            <option value="agendados" {% if status_ex == 'agendados' %}selected{% endif %}>Agendados</option>
            <option value="negado" {% if status_ex == 'negado' %}selected{% endif %}>Negado</option>
            <option value="cancelado" {% if status_ex == 'cancelado' %}selected{% endif %}>Cancelado</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">UBS</label>
          <select name="ubs_ex" class="form-select">
            <option value="" {% if not ubs_ex %}selected{% endif %}>Todas</option>
            {% for u in ubs_list %}
            <option value="{{ u.id }}" {% if ubs_ex|add:'' == u.id|add:'' %}selected{% endif %}>{{ u.nome }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Tipo de Exame</label>
          <select name="tipo_exame_ex" class="form-select">
            <option value="" {% if not tipo_exame_ex %}selected{% endif %}>Todos</option>
            {% for t in tipoexame_list %}
            <option value="{{ t.id }}" {% if tipo_exame_ex|add:'' == t.id|add:'' %}selected{% endif %}>{{ t.nome }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-1 d-grid">
          <button class="btn btn-outline-primary" type="submit"><i class="bi bi-funnel"></i></button>
        </div>
      </form>

      {% if ex_page.object_list %}
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead class="table-light">
            <tr>
              <th>Data Solicitação</th>
              <th>Exame</th>
              <th>UBS</th>
              <th>Status</th>
              <th>Agendamento</th>
            </tr>
          </thead>
          <tbody>
            {% for r in ex_page %}
            <tr>
              <td>{{ r.data_solicitacao|date:'d/m/Y H:i' }}</td>
              <td>{{ r.tipo_exame.nome }}</td>
              <td>{{ r.ubs_solicitante.nome }}</td>
              <td>
                <span class="badge {{ r.get_status_badge_class }}">{{ r.get_status_display }}</span>
                {% if r.status == 'autorizado' and r.data_agendada %}
                  {% if r.data_agendada < hoje %}
                    <span class="badge bg-secondary ms-1">Vencida</span>
                  {% else %}
                    <span class="badge bg-success-subtle text-success border ms-1">Futuro</span>
                  {% endif %}
                {% endif %}
              </td>
              <td>
                {% if r.status == 'autorizado' %}
                  {{ r.local_realizacao }} — {{ r.data_agendada|date:'d/m/Y' }} {{ r.hora_agendada|time:'H:i' }}
                  {% if r.data_agendada and r.data_agendada < hoje %}
                    <div><a class="btn btn-link btn-sm p-0" href="{% url 'regulacao-create' %}?paciente={{ paciente.id }}&tipos={{ r.tipo_exame.id }}">Reagendar</a></div>
                  {% endif %}
                {% elif r.status == 'negado' %}
                  <span class="text-danger">Negado</span>{% if r.motivo_decisao %}<br><small class="text-muted">Motivo: {{ r.motivo_decisao }}</small>{% endif %}
                {% else %}—{% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <nav>
        <ul class="pagination pagination-sm justify-content-end">
          {% if ex_page.has_previous %}
          <li class="page-item"><a class="page-link" href="?{{ qs_ex }}{% if qs_ex %}&{% endif %}page_ex=1">«</a></li>
          <li class="page-item"><a class="page-link" href="?{{ qs_ex }}{% if qs_ex %}&{% endif %}page_ex={{ ex_page.previous_page_number }}">‹</a></li>
          {% else %}
          <li class="page-item disabled"><span class="page-link">«</span></li>
          <li class="page-item disabled"><span class="page-link">‹</span></li>
          {% endif %}
          <li class="page-item disabled"><span class="page-link">Página {{ ex_page.number }} de {{ ex_page.paginator.num_pages }}</span></li>
          {% if ex_page.has_next %}
          <li class="page-item"><a class="page-link" href="?{{ qs_ex }}{% if qs_ex %}&{% endif %}page_ex={{ ex_page.next_page_number }}">›</a></li>
          <li class="page-item"><a class="page-link" href="?{{ qs_ex }}{% if qs_ex %}&{% endif %}page_ex={{ ex_page.paginator.num_pages }}">»</a></li>
          {% else %}
          <li class="page-item disabled"><span class="page-link">›</span></li>
          <li class="page-item disabled"><span class="page-link">»</span></li>
          {% endif %}
        </ul>
      </nav>
      {% else %}
      <div class="text-muted">Nenhum exame encontrado.</div>
      {% endif %}
    </div>
  </div>

  <!-- Consultas -->
  <div class="card mb-4" id="sec-consultas">
    <div class="card-header bg-info text-dark d-flex justify-content-between align-items-center">
      <strong>Consultas</strong>
      {% if co_print_groups %}
      <div class="dropdown d-print-none">
        <button class="btn btn-sm btn-outline-success dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-printer"></i> Imprimir do dia
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          {% for g in co_print_groups %}
          <li>
            <a class="dropdown-item" href="{% url 'comprovantes-consultas' %}?ids={{ g.ids_csv }}" target="_blank">
              {{ g.date|date:'d/m/Y' }} — {{ g.count }} consulta(s)
            </a>
          </li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
    </div>
    <div class="card-body">
      <form method="get" class="row g-2 align-items-end mb-3">
        <input type="hidden" name="inicio" value="{{ inicio }}" />
        <input type="hidden" name="fim" value="{{ fim }}" />
        <input type="hidden" name="q" value="{{ q }}" />
        <!-- preservar filtros de Exames -->
        <input type="hidden" name="status_ex" value="{{ status_ex }}" />
        <input type="hidden" name="ubs_ex" value="{{ ubs_ex }}" />
        <input type="hidden" name="tipo_exame_ex" value="{{ tipo_exame_ex }}" />
        <div class="col-md-3">
          <label class="form-label">Status</label>
          <select name="status_co" class="form-select">
            <option value="" {% if not status_co %}selected{% endif %}>Todos</option>
            <option value="fila" {% if status_co == 'fila' %}selected{% endif %}>Fila</option>
            <option value="pendente" {% if status_co == 'pendente' %}selected{% endif %}>Pendente</option>
            <option value="autorizado" {% if status_co == 'autorizado' %}selected{% endif %}>Autorizado</option>
            <option value="agendados" {% if status_co == 'agendados' %}selected{% endif %}>Agendados</option>
            <option value="negado" {% if status_co == 'negado' %}selected{% endif %}>Negado</option>
            <option value="cancelado" {% if status_co == 'cancelado' %}selected{% endif %}>Cancelado</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">UBS</label>
          <select name="ubs_co" class="form-select">
            <option value="" {% if not ubs_co %}selected{% endif %}>Todas</option>
            {% for u in ubs_list %}
            <option value="{{ u.id }}" {% if ubs_co|add:'' == u.id|add:'' %}selected{% endif %}>{{ u.nome }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Especialidade</label>
          <select name="especialidade_co" class="form-select">
            <option value="" {% if not especialidade_co %}selected{% endif %}>Todas</option>
            {% for e in especialidades %}
            <option value="{{ e.id }}" {% if especialidade_co|add:'' == e.id|add:'' %}selected{% endif %}>{{ e.nome }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-1 d-grid">
          <button class="btn btn-outline-primary" type="submit"><i class="bi bi-funnel"></i></button>
        </div>
      </form>

      {% if co_page.object_list %}
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead class="table-light">
            <tr>
              <th>Data Solicitação</th>
              <th>Especialidade</th>
              <th>UBS</th>
              <th>Status</th>
              <th>Agendamento</th>
            </tr>
          </thead>
          <tbody>
            {% for c in co_page %}
            <tr>
              <td>{{ c.data_solicitacao|date:'d/m/Y H:i' }}</td>
              <td>{{ c.especialidade.nome }}</td>
              <td>{{ c.ubs_solicitante.nome }}</td>
              <td>
                <span class="badge {{ c.get_status_badge_class }}">{{ c.get_status_display }}</span>
                {% if c.status == 'autorizado' and c.data_agendada %}
                  {% if c.data_agendada < hoje %}
                    <span class="badge bg-secondary ms-1">Vencida</span>
                  {% else %}
                    <span class="badge bg-success-subtle text-success border ms-1">Futuro</span>
                  {% endif %}
                {% endif %}
              </td>
              <td>
                {% if c.status == 'autorizado' %}
                  <div class="d-flex align-items-center gap-2 flex-wrap">
                    <span>{{ c.local_atendimento }} — {{ c.data_agendada|date:'d/m/Y' }} {{ c.hora_agendada|time:'H:i' }}</span>
                    <a href="{% url 'comprovante-consulta' c.pk %}" class="btn btn-sm btn-outline-primary d-print-none" title="Imprimir comprovante de consulta">
                      <i class="bi bi-printer"></i>
                    </a>
                  </div>
                  {% if c.data_agendada and c.data_agendada < hoje %}
                    <div><a class="btn btn-link btn-sm p-0" href="{% url 'consulta-create' %}?paciente={{ paciente.id }}&especialidade={{ c.especialidade.id }}">Reagendar</a></div>
                  {% endif %}
                {% elif c.status == 'negado' %}
                  <span class="text-danger">Negado</span>{% if c.motivo_decisao %}<br><small class="text-muted">Motivo: {{ c.motivo_decisao }}</small>{% endif %}
                {% else %}—{% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <nav>
        <ul class="pagination pagination-sm justify-content-end">
          {% if co_page.has_previous %}
          <li class="page-item"><a class="page-link" href="?{{ qs_co }}{% if qs_co %}&{% endif %}page_co=1">«</a></li>
          <li class="page-item"><a class="page-link" href="?{{ qs_co }}{% if qs_co %}&{% endif %}page_co={{ co_page.previous_page_number }}">‹</a></li>
          {% else %}
          <li class="page-item disabled"><span class="page-link">«</span></li>
          <li class="page-item disabled"><span class="page-link">‹</span></li>
          {% endif %}
          <li class="page-item disabled"><span class="page-link">Página {{ co_page.number }} de {{ co_page.paginator.num_pages }}</span></li>
          {% if co_page.has_next %}
          <li class="page-item"><a class="page-link" href="?{{ qs_co }}{% if qs_co %}&{% endif %}page_co={{ co_page.next_page_number }}">›</a></li>
          <li class="page-item"><a class="page-link" href="?{{ qs_co }}{% if qs_co %}&{% endif %}page_co={{ co_page.paginator.num_pages }}">»</a></li>
          {% else %}
          <li class="page-item disabled"><span class="page-link">›</span></li>
          <li class="page-item disabled"><span class="page-link">»</span></li>
          {% endif %}
        </ul>
      </nav>
      {% else %}
      <div class="text-muted">Nenhuma consulta encontrada.</div>
      {% endif %}
    </div>
  </div>

  <!-- Viagens -->
  <div class="card mb-4" id="sec-viagens">
    <div class="card-header"><strong>Viagens</strong></div>
    <div class="card-body">
      {% if vi_page.object_list %}
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead class="table-light">
            <tr>
              <th>Data</th>
              <th>Destino</th>
              <th>Hospital</th>
              <th>Status</th>
              <th>Observações</th>
            </tr>
          </thead>
          <tbody>
            {% for v in vi_page %}
            <tr>
              <td>{{ v.data_viagem|date:'d/m/Y' }} {% if v.hora_saida %}{{ v.hora_saida|time:'H:i' }}{% endif %}</td>
              <td>{{ v.destino }}</td>
              <td>{{ v.hospital }}</td>
              <td><span class="badge {% if v.status == 'aprovado' %}bg-success{% elif v.status == 'cancelado' %}bg-secondary{% else %}bg-warning text-dark{% endif %}">{{ v.get_status_display }}</span></td>
              <td>{{ v.observacoes|default:'—' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <nav>
        <ul class="pagination pagination-sm justify-content-end">
          {% if vi_page.has_previous %}
          <li class="page-item"><a class="page-link" href="?{{ qs_vi }}{% if qs_vi %}&{% endif %}page_vi=1">«</a></li>
          <li class="page-item"><a class="page-link" href="?{{ qs_vi }}{% if qs_vi %}&{% endif %}page_vi={{ vi_page.previous_page_number }}">‹</a></li>
          {% else %}
          <li class="page-item disabled"><span class="page-link">«</span></li>
          <li class="page-item disabled"><span class="page-link">‹</span></li>
          {% endif %}
          <li class="page-item disabled"><span class="page-link">Página {{ vi_page.number }} de {{ vi_page.paginator.num_pages }}</span></li>
          {% if vi_page.has_next %}
          <li class="page-item"><a class="page-link" href="?{{ qs_vi }}{% if qs_vi %}&{% endif %}page_vi={{ vi_page.next_page_number }}">›</a></li>
          <li class="page-item"><a class="page-link" href="?{{ qs_vi }}{% if qs_vi %}&{% endif %}page_vi={{ vi_page.paginator.num_pages }}">»</a></li>
          {% else %}
          <li class="page-item disabled"><span class="page-link">›</span></li>
          <li class="page-item disabled"><span class="page-link">»</span></li>
          {% endif %}
        </ul>
      </nav>
      {% else %}
      <div class="text-muted">Nenhuma viagem encontrada.</div>
      {% endif %}
    </div>
  </div>

  <!-- TFD -->
  <div class="card mb-4" id="sec-tfd">
    <div class="card-header"><strong>TFD</strong></div>
    <div class="card-body">
      {% if tfd_page.object_list %}
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead class="table-light">
            <tr>
              <th>Período</th>
              <th>Destino</th>
              <th>Diárias</th>
              <th>Benefício</th>
              <th>Valor Total</th>
              <th>Observações</th>
            </tr>
          </thead>
          <tbody>
            {% for t in tfd_page %}
            <tr>
              <td>
                {% if t.data_inicio %}{{ t.data_inicio|date:'d/m/Y' }}{% else %}—{% endif %}
                —
                {% if t.data_fim %}{{ t.data_fim|date:'d/m/Y' }}{% else %}—{% endif %}
              </td>
              <td>{{ t.cidade_destino|default:'—' }}</td>
              <td>{{ t.numero_diarias }}</td>
              <td>R$ {{ t.valor_beneficio|floatformat:2 }}</td>
              <td>R$ {{ t.valor_total|floatformat:2 }}</td>
              <td>{{ t.observacoes|default:'—' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <nav>
        <ul class="pagination pagination-sm justify-content-end">
          {% if tfd_page.has_previous %}
          <li class="page-item"><a class="page-link" href="?{{ qs_tfd }}{% if qs_tfd %}&{% endif %}page_tfd=1">«</a></li>
          <li class="page-item"><a class="page-link" href="?{{ qs_tfd }}{% if qs_tfd %}&{% endif %}page_tfd={{ tfd_page.previous_page_number }}">‹</a></li>
          {% else %}
          <li class="page-item disabled"><span class="page-link">«</span></li>
          <li class="page-item disabled"><span class="page-link">‹</span></li>
          {% endif %}
          <li class="page-item disabled"><span class="page-link">Página {{ tfd_page.number }} de {{ tfd_page.paginator.num_pages }}</span></li>
          {% if tfd_page.has_next %}
          <li class="page-item"><a class="page-link" href="?{{ qs_tfd }}{% if qs_tfd %}&{% endif %}page_tfd={{ tfd_page.next_page_number }}">›</a></li>
          <li class="page-item"><a class="page-link" href="?{{ qs_tfd }}{% if qs_tfd %}&{% endif %}page_tfd={{ tfd_page.paginator.num_pages }}">»</a></li>
          {% else %}
          <li class="page-item disabled"><span class="page-link">›</span></li>
          <li class="page-item disabled"><span class="page-link">»</span></li>
          {% endif %}
        </ul>
      </nav>
      {% else %}
      <div class="text-muted">Nenhum TFD encontrado.</div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
